## 阿里巴巴云时代的数据库管理

文/周振兴

>从2009年第一次双十一，到去年912亿的单日交易额，这期间阿里数据库技术团队经历了 Oracle 时代、去 IOE 时代，实现了数据异地双活架构，阿里的数据库规模还在随着业务持续增长，规模化发展到今天已经触发了更多深层次的变化，无论是技术深度，还是服务模式都迎来了新挑战。

数据是阿里巴巴最重要的资产。数据库技术团队最重要的职责之一就是守护阿里的数据，提供安全、稳定、高效、易用的数据库服务是团队最重要的价值。在业务飞速增长的背景下，数据库团队的挑战也越来越大，有来自业务对性能的要求、有规模化暴露出的各种“罕见”的系统问题、有业务多样化与标准化的矛盾、有持续增加的业务研发人员给 DBA 带来的日常压力。所有这些，让数据库技术团队更早地进入云服务时代，甚至在云服务还未兴起时，数据库团队已经通过平台、产品提前进入了云时代。本文将分享我们在探索中的一些经验和思考。

###规模化的挑战

业务持续增长在数据库上的直接体现是实例规模的增长。数据库实例数的规模从原来的几十发展到几千，到现在的几万，这个趋势还没有停止。在早期，规模的增长给我们带来一系列的问题。

#### DBA 无法及时响应所有研发的咨询与需求

随着业务增长的还有研发人员数量。在早期，对于大多数线上系统，DBA 都会参与数据库资源申请、库表结构设计、SQL 审核、线上库表结构索引变更等。但发展到现在，DBA 与研发人员的数量比率已经是1:500的规模，如果还沿用原来的模式，将大大影响研发人员的效率，拖慢业务发展速度。

#### 复杂的环境让手工操作变得危险

随着时间的推移，数据库软硬件环境都在持续变化，例如底层系统升级、硬件标准更换、机房搬迁等都可能导致数据库环境不一致，如果没能识别出这些“非标”环境，就直接在环境上进行变更，很容易导致数据库变更故障。

#### “罕见”的软硬件 Bug 会成为系统性的问题

软件都会有 Bug，数据库也一样。规模化则会放大这些 Bug 对系统的影响。做个计算：如果某个系统正常运行十年出一次故障（平均故障间隔），那么运行一万个该系统的实例，每个月会有多少次？简单计算得到：(1/10/12)*10000 = 83.33。即使数据库平均故障间隔为十年，规模化之后，也会让数据库运维人员疲于奔命。

###云时代的进化之一：构建全自助的企业数据库研发流程

前文提到，随着规模增长，企业研发人员越来越多，DBA 已经不再能及时响应所有研发人员关于数据库的问题。但如果只是简单地把生产数据库权限交给研发，那么可能会导致更多数据库问题，包括数据性能瓶颈让业务不可用、库表索引设计不合理导致的资源浪费等。

#### iDB：企业数据库研发流程平台

阿里数据库团队通过构建全自助的数据库研发流程平台 iDB 来解决这个问题。iDB 全称为“企业数据库研发流程平台”，研发人员使用 iDB 可以自助完成数据库实例申请、库表结构变更发布、线上数据库查询与审计、分库分表自助管理等，另外 iDB 中还继承了大量的 DBA 经验，比如 InnoDB 表尽量使用自增的数字主键、MySQL 5.6哪些 DDL 哪些变更可能会锁表等。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c53026c5abc.png" alt="图1 iDB企业数据库研发流程平台功能架构图" title="图1 iDB企业数据库研发流程平台功能架构图" />

图1 iDB 企业数据库研发流程平台功能架构图

#### 在 iDB 上自助执行数据库的 DDL

具体以线上 DDL 变更为例。最早在企业发展初期，所有的数据库变更都由研发人员自己控制。但当企业规模到一定程度，研发人员随意变更可能会导致线上数据库性能糟糕、库表索引不合理，甚至可能会带来一些数据库安全问题。此时，一般会进行管控，由 DBA 发布数据库相关的变更，这样虽然带来了高质量的库表、索引、SQL，但是对研发效率却有一定的影响。在阿里，我们使用 iDB 平台来解决效率和质量的平衡问题。iDB 平台通过规则引擎将 DBA 积累的经验都传递给研发人员，包括结构规范、索引规范等。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c53029275ca.png" alt="图2 iDB是DBA标准规范的实现平台" title="图2 iDB是DBA标准规范的实现平台" />

图2 iDB 是 DBA 标准规范的实现平台

#### 使用 iDB 管理复杂的数据库对象

除了自助，iDB 还向用户屏蔽了很多复杂的数据库管理操作。以分表管理为例，在阿里巴巴内部，我们大量使用 TDDL 进行线上数据 sharding，带来的好处是随着业务增长数据库不会成为瓶颈，但是也给管理带来了很大的难度，比如每一次 DDL 变更发布，需要对线上所有的分表进行变更，通常我们的分表数量会是1024，那么这个 DDL 变更也需要分成1024次进行；再比如查询一条记录，则需要先计算该数据所属的分表，然后再查询。而在 iDB4 中，我们通过将多个分表组成一个逻辑表，所有操作都只需要在这个逻辑表上进行。DDL 只需要以逻辑表为对象执行一次，查询也只需要使用 SQL 语句查询逻辑表，如果查询条件中有分表字段，iDB 会自动路由到对应分表上；如果查询条件中没有分表字段，iDB 也会使用底层的分布式执行引擎将所有分表查询结果合并成一个结果返回给用户。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c53038e2866.png" alt="图3 像查询普通表一样查询多个分表，屏蔽了复杂的查询过程" title="图3 像查询普通表一样查询多个分表，屏蔽了复杂的查询过程" />

图3 像查询普通表一样查询多个分表，屏蔽了复杂的查询过程

### 云时代的进化之二：构建标准化、自动化的基础设施平台

阿里数据库团队在支持业务的发展中，为了彻底解决标准化和自动化的问题，我们构建了一套强大的数据库基础设施平台，内部我们称为 DBFree Cloud。它会完成从机器上架之后到提供数据库服务的所有操作，包括构建数据库容器、安装配置实例、配置监控、设置容灾切换系统、分配资源并进行隔离等。

使用 DBFree Cloud 自动化操作带来的好处是：

- 通过系统构建标准化的环境，让所有自动化成为可能

- 在标准化系统中，每解决一个问题就是解决了一类问题

- 让数据库运维的扩展能力不再受到人数的限制

- 减少人为介入，一方面减少了不标准的系统，另一方面也减少了失误。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c5304a63a6b.png" alt="图4 DBFree功能架构图" title="图4 DBFree功能架构图" />

图4 DBFree 功能架构图

### 云时代的进化之三：让研发具备 DBA 的能力

研发人员向 DBA 求助，很大一部分情况是因为数据库性能问题。性能问题通常也很复杂，有可能来自各个层面，帮助研发解决这类问题也是 DBA 的核心竞争力之一。前面提到，因为规模化带来的一个问题是：DBA 不再对研发人员的每一条 SQL 语句进行审核，而是由研发人员自助完成 SQL 审核与优化。在 iDB 平台中，我们提供了“诊断与优化模块”，该模块负责解决用户关于数据库“诊断与优化”相关的问题。通过这个产品我们向所有的研发团队都提供了一个云端的、随时在线的“资深 DBA”服务。举一个典型的例子，以前 DBA 大概每隔一段时间都会遇到一次由于隐式类型转换导致的无法使用索引。如果使用 iDB 的“诊断与优化模块”，研发人员可以随时使用这个云端“资深 DBA”，轻松找到问题。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c530561a2b1.png" alt="图5 iDB的优化与诊断模块会自动告知研发人员SQL语句中可能存在的问题" title="图5 iDB的优化与诊断模块会自动告知研发人员SQL语句中可能存在的问题" />

图5 iDB 的优化与诊断模块会自动告知研发人员 SQL 语句中可能存在的问题

除了性能诊断，iDB 的“诊断与优化模块”还提供了一系列相关功能，例如会话诊断、空间诊断、安全诊断、配置诊断等。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c530633c459.png" alt="图6 iDB向研发人员提供完整的数据库诊断和优化模块" title="图6 iDB向研发人员提供完整的数据库诊断和优化模块" />

图6 iDB 向研发人员提供完整的数据库诊断和优化模块

### 云时代的进化之四：DBA 的进化

在阿里巴巴，数据库技术团队已经不再是单纯的 DBA 团队，还包括数据产品、内核研发、基础技术等。传统的 DBA 工作方式和技能在这个环境下都会面临巨大的挑战。一方面，规模化带来大量系统问题需要解决；另一方面，研发人员数量也在持续增长，DBA 已经不再能解答每一个研发关于数据库使用的问题。迎难而上，我们做了如下改变：

- 不再处理重复的日常，取而代之DBA来制定标准与流程

- 解决深入的、极端的系统问题，不断形成新的最佳实践

- 探索新技术，解决多样化需求与标准化的矛盾，让新技术成为新常态

因为无需再处理原来的“DBA 日常”，所以可以预见传统的 DBA 会越来越少，同时又因为深入的、极端问题处理难度会越来越高，对 DBA 技能要求会更高，技能栈也要求更全，但另一面，“规模化”会把专业 DBA 价值放得更大。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c5306d5d8e0.png" alt="图7 传统DBA角色的探索" title="图7 传统DBA角色的探索" />

图7 传统 DBA 角色的探索

### 结束语

走过 Oracle 时代、去 IOE 时代，实现了数据库的异地双活架构，在今天的云时代，阿里巴巴数据库技术团队通过 iDB 向研发人员赋能自助完成数据库操作、构建强大基础设施平台 DBFree Cloud、实现运维能力的自由扩展，将 DBA 从传统职责中解放出来，去制定流程标准、探索新技术、解决深入的系统问题、扩展数据库内核的能力。我们还在持续探索和不断进化。