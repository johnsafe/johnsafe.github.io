## 直播技术架构探索与优化

文/郝飞

### 直播技术架构
直播涉及很多环节，从音视频采集、编码、媒体流封装、网络转发，再到播放端接收、解码、播放，其中每个环节都涉及很多细节，其基本结构如图1所示。

<img src="http://ipad-cms.csdn.net/cms/attachment/201610/57f9dd23bd5ef.png" alt="图1  直播架构图" title="图1  直播架构图" />

图1  直播架构图

音视频数据分别进行采集和编码，视频数据的采集方式包括摄像头、桌面、图片、视频文件，以及带视频采集的各类设备。

音视频数据经过编码后根据封装格式进行复用处理，然后封包后发到流媒体服务器，目前通用的直播协议采用的是 RTMP。

云端的数据分发使用 CDN 网络，其作用主要包括两点：第一是保证用户请求流媒体的网络质量，CDN 会选择离用户最近的节点为其提供服务；第二是通过流媒体服务器的级连方式保证大并发用户支持。

媒体流在云端除了进行转发，还要进行转码，切片（HLS）和录制等处理。转码可以支持多种分辨率格式，从而满足不同屏幕对不同分辨率码流的要求；转 HLS 协议主要是为了支持手机 H5 端观看；同时，码流会被录制下来，供以后点播使用。 

<img src="http://ipad-cms.csdn.net/cms/attachment/201610/57f9ddbf97b9b.png" alt="图2  视频显示前的准备步骤" title="图2  视频显示前的准备步骤" />

图2  视频显示前的准备步骤

观看直播的用户根据接入运营商和位置信息会得到就近的 CDN 节点，后续的流媒体数据就是通过此服务节点进行拉取的。

### 性能优化

性能优化，顾名思义就是保证系统在正确运行的前提下，提高速度，优化用户体验。

所谓的秒开就是从点击直播节目开始到出现第一帧图像的时间控制在一秒以内，有了这种体验，用户使用起来才会感觉足够顺畅；如何才能达到秒开的效果呢？首先我们来分析下第一帧视频显示前需要哪些步骤。

- 播放器首先通过 DNS 解析来获取流媒体访问节点；

- 播放器与最近的流媒体节点建立连接，然后根据所使用的协议进行握手；

- 从 CDN 节点接收流媒体数据后，Demux 从流数据中区分出音频和视频的数据信息，分别交给音视频解码器；

- 音视频解码器进行解码操作，对于视频来说，由于 B 帧和 P 帧都要参考 I 帧，因此解码的第一帧必须是 I 帧；之前的视频数据都称为无效数据；  

- 音视频解码后的数据发送给上层 player 进行同步播放。

从以上流程，大家可以了解到，通过以下方面的优化可以减少第一帧图像显示的时间：

- DNS 解析优化：可以考虑在空闲时使用 Ping 命令获得域名对应的 IP，从而减少域名解析时间。

- 传输层使用 UDP：优点是连接建立速度快，流传输效率高；缺点是应用层需要解决网络丢包的问题；目前大部分 CDN 不支持 UDP 协议的直播。

- 使用 Http-FLV 协议替代 RTMP 协议：目前播放端直播协议主要包括 HLS、RTMP、HTTP-FLV，其中 HLS 延迟比较大，直播类 App 更倾向于使用 RTMP 和 HTTP-FLV 协议，它们的延迟基本上在一个数量级；从满足秒开的体验来看，建议使用 HTTP-FLV，相比于 RTMP，FLV 的握手协议要简单很多，图3为两种握手协议对比。

<img src="http://ipad-cms.csdn.net/cms/attachment/201610/57f9dd92558d6.png" alt="图3  RTMP和HTTP-FLV对比图" title="图3  RTMP和HTTP-FLV对比图" />

图3  RTMP 和 HTTP-FLV 对比图

- 服务端 GOP 数据缓存，减少播放端拿到无效流数据：由于播放端必须拿到 I 帧后才能够开始解析，因此服务端缓存 GOP 数据后，可以避免与播放端无效数据的传递，从而减少秒开时间。

### 美颜&水印优化

目前的美颜效果主要是磨皮和美白。磨皮的本质就是模糊，常使用的算法包括高斯模糊和双边滤波，后者在边缘上的处理效果更好。这些算法的实现在 GPUImage 这个开源项目中都有，可以很容易地集成到应用中。但是简单的滤波算法还不足以满足大家对美颜的要求；我们对美颜处理主要经过三个版本：第一个版本的实现就是使用双边滤波，其特点是运行速度快，但是效果一般；第二个版本使用了双边滤波＋肤色检测＋轮廓识别＋亮度调节的滤波组合；其美颜效果很不错，但问题是性能开销太大，中档以下机型会有些卡顿，并且发热量大； 最后的版本采用的单滤镜＋亮度肤色调节，兼顾了性能与效果，性能与第一个版本类似。效果上与第二个版本类似； 图4是三个版本的美颜效果对比。

<img src="http://ipad-cms.csdn.net/cms/attachment/201610/57f9deb7bad1b.png" alt="图4  美颜效果对比图" title="图4  美颜效果对比图" />

图4  美颜效果对比图

水印是直播中常见的功能之一，它可以用于简单的版权保护和广告设置。其实现一般是在主播端或者服务端实现，很少在观看端实现。因为如果放在观看端，可能会有些恶意竞争者直接拿到未加水印的视频流，这样就起不到数字保护的作用了。视频内嵌水印的实现比较简单，就是水印图片与视频图片的合成，大部分图像处理的库中都包含这个功能，如 OpenCV。

### 移动直播遇到的坑

都说程序员的工作就是一个挖坑和填坑的过程，那么，在做移动直播时，通常会遇到哪些坑呢？

- 系统延迟大，特别是累积延迟高，播放时间越长，延迟越大。 

影响延迟的环节包括音视频预处理、编码、CDN 分发、拉流、解码等。其中预处理、编码和解码引入的延迟与设备硬件相关，可以通过提升设备性能优化；而 CDN 分发和拉流所引入的延迟则是网络环境决定的，转发节点越多，延迟越大；播放端与节点之间的出现丢包，网络抖动等，也会导致延迟增加。针对于累积延迟，播放端可以采用动态追帧的方法，在尽量不影响视频质量的前提下处理丢帧；同理，主播端如果发现也有视频帧累积现象，也可以考虑丢帧处理，前提也是尽量不要影响视频质量。

- 播放出现卡顿情况，影响用户体验。 

视频卡顿主要是客户端和 CDN 之间的网络环境导致的。

如果主播端上行网络环境不好，则所有观看端都会受影响，可以考虑通过减少帧率或者动态调节码率的方式保证主播端推流稳定。 

如果 CDN 的某个分发节点出现问题，则路由到此节点下的所有客户端观看都会受到影响，这种情况可以通过采用第三方监控，或者收集客户端卡顿报告的方式尽早发现并修复。 

如果某个客户端的网络环境不好，则主要影响此用户观看体验，一般的视频流在服务端都会转成不同码率的几路视频，播放端可以动态切换到低码率，从而保证观看流畅。

- 视频启动慢，用户体验差 

播放启动慢会严重影响用户体验，解决办法可以参考以上提到的秒开的实现。

- Android 机器适配不够，出现崩溃、闪退等现象 

- 主播手机发烫，画面卡顿，特别是增加美颜特性后 

直播涉及到音视频预处理、编码，特别是美颜功能等耗 CPU 资源的操作，因此会出现手机发烫等情况，特别是低端的手机。建议主播端尽量采用高端手机，这些手机不仅是 CPU 能力强，同时还支持硬件的编解码功能，可以大大降低功耗；同时，美颜实现的方式不同对于减轻发热也很有帮助，具体可以参考上面的美颜介绍。

### 直播技术入门与进阶

如果在应用中嵌入直播功能，仅从应用的角度理解直播的流程，技术门槛并不高，一般开发者，通过调用直播平台接口就可以快速地把直播功能嵌入到系统中了；但如果希望从事直播相关系统的开发，就需要学习很多相关知识，具体可参考 CSDN 直播技术知识库。

### 结语

本文主要以亲加在直播业务上的技术架构为例，把直播中需要用到的技术与方法进行总结与优化，并且分享直播技术上面的难点和解决方案。