## 科大讯飞基于 Spark 的用户留存运营分析及技术实现

文/于俊，万文强，刘丹月

上善若水，水善利万物而不争。数据一如水，无色无味，非方非圆，以百态存于自然，于自然无违也；绵绵密密，微则无声，巨则汹涌，与人无争却又容纳万物。

当前，铺天盖地的“大数据”汹涌而至，“完全占领”了互联网和 IT 领域之后，开始渗透到各行各业，形成了政府大数据、教育大数据、医疗大数据、交通大数据、金融大数据、保险大数据、公安大数据、法院大数据、旅游大数据、农业大数据等等。

可以说，我们几乎无法绕开数据而生活，无论是工具、游戏还是生活类 App，用户留存都是一个重要的数据分析指标。如何能够留住用户，成了大数据兴衰成败的关键；留存成为衡量一个产品是否健康发展的重要标准。接下来，我们从讯飞输入法的用户留存运营分析和技术实现开启探讨之旅。

### 运营分析

任何产品都希望用户快速增长，但仅看新增用户数量是没有意义的。产品需要保持用户的活跃度，一旦产品的用户活跃度下降，就意味着用户的流失，而用户留存率就是用来衡量产品活跃度的关键指标。常常能遇到皱着眉头、带着疑惑寻求关于用户留存解答的产品和运营经理们：

>“我们最近投入了较多人力和成本为用户引入了大量有趣的表情包和皮肤到产品中来，似乎下载和使用的用户也不少，不知道这些内容到底能不能提高用户黏性，降低用户流失率。”

>“最近有个版本出现了一些不稳定，可能会引起输入法界面闪退，虽然新版本已经修复了这个 bug，但还是有些担心会不会造成很多用户流失。另外，我们一直辛辛苦苦优化版本的稳定性，到底用户买不买账呢？”

>“通过活动可以为产品带来大量用户，但活动渠道的用户留存率究竟如何，我们的资金是否最优地被使用呢？”

作为衡量产品最重要指标之一，产品和运营工作的许多方面都是围绕留存率提升而展开的，怎样从数据的角度寻找影响留存率的因素，并分析这些因素是怎样正向提升或负向降低用户留存率，是数据分析的重点，数据分析的步骤如下：

#### 明确目标

要明确分析的目标是什么，在运营和产品可以有行动的领域内，召集运营和产品相关人员，一起挖掘对用户留存有影响的指标，并定量评估这些影响作为需求，然后得出类似表1的影响因子列表，同时给出每个影响因子影响程度的预判。

**表1  留存影响因子列表**

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb830b7c596.jpg" alt="表1  留存影响因子列表" title="表1  留存影响因子列表" />

#### 量化指标

将指标进行量化，如版本稳定性这样的影响因子，可以通过崩溃日志和错误日志计算出每个版本的崩溃率、出错率等指标来表达；如评估下载表情包这样的行为是否会提升留存率，则可以直接计算用户下载表情包个数，使用表情包次数这样的指标；如要验证用户的留存率是否随着活动渠道效果提高而提高，则可将每个活动渠道的用户成本作为指标；如果有人提出地区这样非连续数值型也非有序型的指标时，需要分析究竟是地区间的哪些差异会导致留存率不一样，比如地区的 WiFi 覆盖、网络普及度，以及用户打字习惯等因素会引起用户对输入法产品的黏性有差异，然后将地区这样的指标转化为上述可量化的数值型或有序型指标。

考虑到模型的响应变量是每个用户小簇的留存率，我们需要在上述指标不同值的组合下，将用户分成众多小簇，并计算每个小簇的留存率指标。有时受限于我们拥有的数据，并不是列举的所有留存影响因素都能被处理成量化的指标，就需要把收集这些数据的需求提给产品通过技术手段获得。

#### 对数据进行整理清洗，指标计算降维

由于记录过程存在某些异常，或实际情况出现的极端个例，会对模型的训练造成干扰。通过聚类观察分布等异常点检测手段，去除异常值，处理缺失值，保证数据集合理干净。当训练数据的指标维数太高时，容易造成模型过拟合，且相互独立的特征维数越高，在测试集上达到相同的效果表现所需要的训练样本的数目就越大。此外，指标数量过多，训练、测试以及存储的压力也都会增大，可运用主成分分析等手段，以 Spark 为工具对数据集进行计算降维。

#### 建模运算

考虑到讨论的影响因子和响应变量都可以化为连续型的数值指标，数值的大小有着明确的业务上的意义，使用多元线性回归模型来拟合每个因子对留存率的影响。通过 Spark 的 MLlib 中的回归模型对数据进行建模运算，得到指标与响应变量的相关性和拟合公式的指标系数，定量给出每个指标所代表的影响因子对留存率的影响。

#### 结果解释和后置分析

假设我们得到了模型给出的拟合公式：

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb8376e51cc.jpg" alt="" title="" />

是否就得出，只要提升系数大于0的几个指标就能提升留存率？ 事实并不一定如此。因为影响因子和留存率之间有正向相关关系并不等同于因果关系，比如，爱好下载和使用表情包的用户有着更高的留存率，拟合公式的系数也为正，但实际情况是，爱好下载和使用表情包的用户天然就是高活跃度的用户，本身具有较高的留存率，这些用户的留存率并不是因为下载和使用表情包的行为而提高。如图1所示，通过数据发现，虽然使用表情包的用户整体留存率高于普通用户，但使用表情包的用户在使用前后的留存率和普通用户在同期的前后变化一样，并没有显著提升。这样就不能得出提升用户的表情包使用率会提升用户的留存率这一结论。

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb83b8ce6cb.jpg" alt="图1  普通用户、使用表情包用户留存分析表" title="图1  普通用户、使用表情包用户留存分析表" />

**图1  普通用户、使用表情包用户留存分析表**

运营分析建立在精准用户留存计算结果之上，如何对用户留存进行技术实现是我们接下来要考虑的重点。

### 技术实现

随着互联网大数据的发展，对用户留存的技术实现已经从简单、小数据量的分析，过渡到任意周期、海量数据的分析，并要求实现即席查询、多维交叉分析等高级功能。技术实现步骤和技术演进情况如下。

#### 需求分析

用户在某段时间内使用产品，经过一段时间后，仍然继续使用该产品被称为用户留存，这部分用户所占比例称为留存率。

分析产品的用户留存状态有多种分类方式。按照用户种类划分，可以分为新增用户留存和活跃用户留存；按照时间维度划分，可以分为日留存、周留存和月留存；还可以根据特定业务场景自定义留存指标，如任意周期内的滚动周留存等。

新增用户的周留存率如图2（友盟统计演示 demo）所示。

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb844839f99.png" alt="图2  新增用户的周留存率" title="图2  新增用户的周留存率" />

**图2  新增用户的周留存率**

可以看出，新增用户随着时间推移的留存情况可以分为流失期（第1周）、蒸馏期（第2-5周）、稳定期（第6-8周）三个阶段。留存率的变化是流失期大幅度下降，蒸馏期下降幅度减缓，最后逐渐达到稳定状态。

其中流失期是对产品质量的直接体现，它反映出产品吸引新增用户再次使用的能力。当留存率达到稳定期后，此时的留存才是该产品的真实留存，稳定期保留下来的用户，才是产品最有价值的用户。

#### 面临的挑战

在实际的大规模生产环境中，用户留存的计算存在以下挑战：
- 计算量大，资源耗费严重。以讯飞输入法为例，截止2015年12月总用户超过2.8亿，月活用户超过8000万，每个月 ETL 后的活跃日志超过20亿条记录。在计算月留存的时候，需要对这20亿条记录进行 distinct/join 等操作，资源与时间的开销都非常严重。

- 计算逻辑复杂，执行代价高。一般来说，标准留存的实现方式比较统一，但是自定义留存的实现就不那么简单了，任意周期的滚动周留存如图3所示。

  <img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb848e479b1.png" alt="图3  任意周期的周留存率" title="图3  任意周期的周留存率" />

  **图3  任意周期的周留存率**

此处存在两个关键点，分别是“任意周期”和“滚动周”。如果穷举所有时间周期和滚动周的组合，那么实现代价非常大，而且这种“暴力”解法，在实际生产环境中也是不现实的。

#### 技术演进

随着用户留存计算难度的增加，技术实现也在一路演进。

- MapReduce 时代。说起大数据，很多人会想起 Doug Cutting 以自己儿子玩具小象命名的开源项目 Hadoop，早在2013年，业务技术栈集中于 MapReduce 计算框架，各类数据分析指标均由数据分析人员通过 Pig Latin 编写。当时的用户规模和计算资源，Pig 是完全能够胜任留存等指标的计算。

- 拥抱 Spark。到了2014年中旬，随着用户规模的爆发式增长，Pig 逐渐显现出疲态。它不仅延续了 MapReduce 公认的“慢”，而且在处理复杂逻辑时还需要使用 UDF （用户自定义函数）。恰逢 Spark 发布1.0版本，其基于内存的 RDD 模型、DAG 图的拓扑结构、Lineage 的容错机制、统一的数据处理令人眼前为之一亮，于是将基于 MapReduce 的业务向 Spark 迁移，对时间开销进行了有效优化。

- 质的飞跃。虽然迁移至 Spark 后性能有了提升，但是20亿条记录级别的数据仍需要进行 join 操作，我们依然被这一问题困扰着。随着 Spark 和 Bitmap 数据结构的有效结合，实现了 Spark+Bitmap 在用户留存指标计算上的应用，为每个用户建立 Index，Bitmap 中的每一位代表一个用户是否活跃（如：0表示未活跃，1表示活跃）。每天离线生成一个 Bitmap，日留存只需要将两天的 Bitmap 进行 AND 操作即可，具体的细节如下：

    - 用户 Index 的建立，初始化阶段，考虑到 Bitmap 是基于RLE （Run Length Encoding）压缩技术，产品的活跃用户又是稀疏的，因此将流失用户的 Index 往前放，从而优化存储空间。而后每日离线情况下，只需要生成新增用户的 Index。因为 Spark 任务的 tas 数目与文件 partition 数目有关，因此我们对用户 Index 进行了按月合并操作。

    - Bitmap 的生成，每天离线生成一份按版本、按渠道等维度的 Bitmap，不仅可以完成留存指标的计算，同时也可以用于计算新增、活跃、用户筛选等需求。Spark 中可以将数据抽象视为 RDD、Partition、Record 三种粒度，经过实验得出，将 EWAH 压缩技术与 Partition 相结合，在每个 Partition 内生成 Bitmap 效果较好。实际处理过程中，由于可能会产生数据倾斜的情况，所以需要根据自身的业务场景设置合理的 Partitioner。

    - 存储的演变，之前在 MapReduce 和 Spark 的版本中，存储活跃日志明细在 HDFS 上。而在 Spark+Bitmap 的版本中，我们将生成的 Bitmap 存至 HDFS、HBase、Tachyon 中，以应对不同场景的业务需求。
  
    - 用户留存计算的流程，如图4所示月留存的计算演进。

      <img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb84ffedd32.png" alt="图4  用户留存计算流程图" title="图4  用户留存计算流程图" />

      **图4  用户留存计算流程图**

    - 时间开销比较，采用10台16核 CPU、64 GB 内存的集群进行实验，使用 Standalone 模式生成 Bitmap 所需的时间空间开销如表2所示。

      **表2  生成Bitmap的时间空间开销**

      <img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb853471d5c.png" alt="表2  生成Bitmap的时间空间开销" title="表2  生成Bitmap的时间空间开销" />

      月留存的计算时间消耗对比之前方案的效果如图5所示。

      <img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb857b9209b.png" alt="图5  用户留存计算耗时对比" title="图5  用户留存计算耗时对比" />

      **图5  用户留存计算耗时对比**

    - 即席查询，解决了“计算量大，资源耗费严重”的难题后，又将目光投向任意周期的滚动周留存指标上。有了 Bitmap 这把利器，无需再采用“暴力”解法离线生成自定义留存指标。正因为 Bitmap 位运算速度快的优势，可以将其做成线上即席查询服务，而 Spark-Jobserver 就能很好的胜任这一点。Spark-Jobserver 提供了一个用于提交和管理Apache Spark作业（job）、jar 文件和作业上下文（SparkContext）的 RESTful 接口。只需要离线将 Bitmap 生成并存储至 HBase 中，当页面进行查询请求时，通过 Spark-Jobserver 提交 Spark 作业，秒级内查询得出需要的留存指标结果。

#### 未来思路

除了计算用户留存之外，还可以将 Bitmap 与用户召回、用户画像、OLAP 等手段相结合，进行进一步的分析挖掘，从而做到对用户、对产品的精准洞察。

使用 Bitmap 统计召回用户。召回用户，是指某段时间的活跃用户，在接下来的 N 天/周/月内从未活跃。以统计12月31日的30天召回用户为例（即11月30日之前活跃，12月01日至12月30日从未活跃，而12月31日又重新活跃的用户），见图6用户召回计算流程。

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb85c78251e.png" alt="图6  用户召回计算" title="图6  用户召回计算" />

**图6  用户召回计算**

用户画像与 Bitmap 相结合。除了基于基础维度（版本、渠道等），深入的用户留存分析可以与用户画像相结合。对用户的画像标签生成 Bitmap，便可以更加精细的定位人群加以分析。甚至，通过用户画像与 Bitmap，可以构建出多维交叉分析引擎。OLAP 与 Bitmap 相结合，OLAP 在基于数据仓库多维度模型的基础上实现的面向分析的各类操作的集合。OLAP 多维分析操作包括：钻取（Drill-down）、上卷（Roll-up）、切片（Slice）以及旋转（Pivot）。 多维数据在存储中形成数据立方体（Data Cube），常见的上卷操作是对 Cube 中细粒度数据向高层的聚合，一般解决类似 pv 的问题，无法解决 uv 去重的情况。如果将 Bitmap 与 Cube 立方体相结合，便能解决上卷聚合过程中的 uv 去重问题。

### 总结

用户留存分析是需要长期持续跟踪的，它不仅能够反映出产品对于用户的粘性，还能分析得出用户引导、产品功能改进、版本发布缺陷、运营活动推广等带来的影响。

用户留存分析，来源于业务，服务于业务，将用户数据化，用大数据精准洞察用户留存，实现数据价值。 