## 高性能数据库中间件 MyCAT

文/ 满春

>MyCAT 起源于 Cobar，青出于蓝而胜于蓝，除了持续增强原来优异的分布式分库分表功能外，又结合集群管理、自动扩容、智能优化，成为互联网高性能中间件的代表。

### MyCAT 起源

MyCAT 脱胎于 Cobar，因为 Cobar 在社区使用过程中发现存在一些比较严重的问题及使用限制，经过 MyCAT 发起人的改良，于是诞生了。MyCAT 对 Cobar 的代码进行了彻底的重构，使用 NIO 重构了网络模块，并且优化 Buffer 内核，增强了聚合、Join 等基本特性，同时兼容绝大多数数据库，成为通用的数据库中间件。从1.4版本后已经基完全脱离了 Cobar 的内核。

### MyCAT 分库分片

MyCAT 的结构如图1所示：

<img src="http://ipad-cms.csdn.net/cms/attachment/201606/574e3f996d83b.png" alt="图1 MyCAT结构图" title="图1 MyCAT结构图" />

图1 MyCAT 结构图

MyCAT 核心模块是分库分片，读写分离等，这里涉及到数据库切分，包括水平切分和垂直切分。

水平切分：简单来说，我们可以将数据的水平切分理解为是按照数据行的切分，就是将表中的某些行切分到一个数据库，而另外的某些行又切分到其他的数据库中。当然，为了能够比较容易的判定各行数据被切分到哪个数据库中，切分都是需要按照某种特定的规则来进行的。如根据某个数字类型字段基于特定数目取模，某个时间类型字段的范围，或者是某个字符类型字段的 Hash 值。如果整个系统中大部分核心表都可以通过某个字段来进行关联，那这个字段自然是一个进行水平分区的上上之选。当然，非常特殊无法使的用就只能另选其它，水平拆分示意图如图2所示。

<img src="http://ipad-cms.csdn.net/cms/attachment/201606/574e3faaa39d1.png" alt="图2 水平拆分图" title="图2 水平拆分图" />

图2 水平拆分图

#### 水平拆分的优点

- 表关联基本能够在数据库端全部完成；

- 不会存在某些超大型数据量和高负载的表遇到瓶颈的问题；

- 应用程序端整体架构改动相对较少；

- 事务处理相对简单；

- 只要切分规则能够定义好，基本上较难遇到扩展性限制。

#### 水平切分的缺点

- 切分规则相对更为复杂，很难抽象出一个能够满足整个数据库的切分规则；

- 后期数据的维护难度有所增加，人为手工定位数据更困难；

- 应用系统各模块耦合度较高，可能会对后面数据的迁移拆分造成一定的困难；

- 跨库 Join 性能比较差。

垂直切分：相对于水平拆分来说，垂直拆分比较容易实现，其含义是把数据库中不同业务数据拆分到不同数据库中。垂直拆分能很好的起到分散数据库压力的作用。业务模块不明晰，耦合（表关联）度比较高的系统不适合使用这种拆分方式。针对于垂直切分可能遇到数据切分及事务问题，在数据库层面很难找到一个较好的处理方案。在实际应用案例中，数据库的垂直切分大多是与应用系统的模块相对应，同一个模块的数据源存放于同一个数据库中，可以解决模块内部的数据关联问题。而模块与模块之间的访问，以前是通过应用程序以服务接口方式来相互提供所需要的数据。现在我们可以考虑用 MyCAT 来实现拆分之后数据库模块的相互访问。虽然这样做在数据库的总体操作次数方面确实会有所增加，但是在系统整体扩展性以及架构模块化方面，都是有益的，如图3所示。

<img src="http://ipad-cms.csdn.net/cms/attachment/201606/574e3fb9bcfe8.png" alt="图3 垂直拆分图" title="图3 垂直拆分图" />

图3 垂直拆分图

#### 垂直拆分的优点

- 数据库的拆分简单明了，拆分规则明确；

- 应用程序模块清晰明确，整合容易；

- 数据维护方便易行，容易定位。

#### 垂直切分的缺点

- 部分表关联无法在数据库级别完成，需要在程序中完成；

- 对于访问极其频繁且数据量超大的表仍然存在性能瓶颈，不一定能满足要求；

- 事务处理相对更为复杂；

- 切分达到一定程度之后，扩展性会遇到限制；

- 过度切分可能会带来系统过渡复杂而难以维护。

总结起来，这两种拆分的总体缺陷是：

- 引入分布式事务的问题；

- 跨节点 Join 的问题；

- 跨节点合并排序分页问题；

- 多数据源管理问题。

针对这些问题，MyCAT 通过数据切分解决传统数据库的缺陷，又有 NoSQL 易于扩展的优点，通过中间代理层规避多数据源的处理问题，对应用完全透明，同时对数据拆分后存在的问题，也做了解决方案。如今 MyCAT 的经典应用场景有如下部分：

1. 单纯的读写分离，此时配置比较简单，支持读写分离，主从切换；

2. 分库分表，对于超过 1000W 的表进行分片，最大支持1000亿的单表分片；

3. 多租户使用，每个应用一个库，但应用程序只连接 MyCAT，从而不改造程序本身，实现多租户化；

4. 报表系统，借助于 MyCAT 的分表能力，处理大规模报表的统计；

5. 替代 HBase，分析大数据；

6. 作为海量数据实时查询的一种简单有效方案，比如100亿条频繁查询的记录要在3秒内查询出来结果，除了基于主键的查询，还可能存在范围查询或者其它属性查询，此时 MyCAT 可能是最简单有效的选择。

#### MyCAT 分布式架构

前面介绍了 MyCAT 起源以及核心功能模块分库分表，那么 MyCAT 到底是什么？MyCAT 其实就是数据库中间件，介于数据库和应用之间，进行数据交互和处理的中间服务。

<img src="http://ipad-cms.csdn.net/cms/attachment/201606/574e3fc5536fb.png" alt="图4 MyCAT 架构图" title="图4 MyCAT 架构图" />

图4 MyCAT 架构图

如图4所示所示，数据被分片到数据库后，应用如果需要读取数据，就需要处理多个数据源的数据，如果没有数据中间件，那么应用将直接面对分片集群，数据源切换、事务处理、数据聚合等都需要应用直接处理，而原本是专注于业务的应用，现在将会花大量的工作来处理分片的问题，值得提醒注意的是每个应用的处理将会是完全重复造轮子。所以有了 MyCAT 数据库中间件，应用只需要集中业务处理，大量通用的数据聚合，事务、数据源切换都由中间件来处理，中间件的性能与处理能力将直接决定应用的读写性能。

#### MyCAT 与同类中间件的比较

TDDL 不同于其它几款产品，并非独立的中间件，只能算作中间层，是以 Jar 包方式提供给应用调用的。属于 JDBC Shard 的思想，网上也有很多其它类似产品。

Amoeba 作为一个真正的独立中间件提供服务，即应用去连接 Amoeba 操作 MySQL 集群，就像操作单个 MySQL 一样。从架构中可以看来，Amoeba 算中间件中的早期产品，后端还在使用 JDBC Driver。

Cobar 是在 Amoeba 基础上进化的版本，一个显著变化是把后端 JDBC Driver 改为原生的 MySQL 通信协议层。后端去掉 JDBC Driver 后，意味着不再支持 JDBC 规范，不能支持 Oracle、PostgreSQL 等数据。但使用原生通信协议代替 JDBC Driver，后端的功能增加了很多想象力，比如主备切换、读写分离、异步操作等。

MyCAT 又是在 Cobar 基础上发展的版本，两个显著的优势是：

- 后端由 BIO 改为 NIO，并发量有大幅提高；

- 增加了对 Order By、Group By、Limit 等聚合功能的支持（虽然 Cobar 也可以支持 Order By、Group By、Limit 语法，但是结果没有进行聚合，只是简单返回给前端，聚合功能还是需要业务系统自己完成）。

从目前社区情况来看： 

- TDDL 处于停滞状态；

- Amoeba 处于停滞状态；

- Cobar 处于停滞状态；

- MyCAT 社区非常活跃。

抛开 TDDL 不说，Amoeba、Cobar、MyCAT 这三者的渊源比较深，若 Amoeba 能继续下去，Cobar 就不会出来；若 Cobar 那批人不是都走光了的话，MyCAT 也不会再另起炉灶。所以说，在中国开源的项目很多，但是能坚持下去的非常难，MyCAT 社区现在非常活跃，也真是一件让大家幸福的事情。因为 MyCAT 社区会持续为提供开源免费高效的技术服务，所以在分库分表时，不妨考虑使用 MyCAT 这款中间件产品。