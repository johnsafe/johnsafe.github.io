## 做好数据库运维——DBA 岗位分析及实践经验分享

文/王林平

>数据库管理究竟是什么类型的工作岗位？在企业中数据库管理员怎么能做好工作，获得更好的回报？人是会犯错误的，应该如何建立流程规范，提高数据库的稳定性？运维人员应该如何提升自我修养以适应行业发展和企业业务的发展？本文将和大家探讨上面提出的几个问题。

### 数据库管理员是哪种类型的岗位

在刚成为一个 DBA（数据库管理员）时，我觉得 DBA 就像武侠片里的侠客一样，所有事情一个人搞定。也确实在无数个漆黑的夜晚，配合同事守着公司线上的服务，一次次默默完成数据库的迁移、切换、升级，颇有侠客的意味。但是随着学习、熟练和不断经历运维工作，这个看法有很大的改观。

第一，DBA 互相配合。笔者曾经经历过一次 Oracle 9i 升级至 Oracle 10G 的操作，升级方案经过多次测试，从晚上22：30开始准备，操作至第二天1:30，碰到一个时间类型处理问题，由于问题之前没有碰到过有些紧张，同时由于准备工作时间挺长，脑子有些迷糊，不知道怎么处理了，还好我的主管当时在线，经过几分钟沟通，她给了我一个建议方案，后续的操作就顺利完成了。数据库运维岗位经常要处理线上故障、进行线上操作、迁移线上服务，同时又要保证服务的7*24小时稳定高性能运行，因此是一个时刻有较大压力的岗位，每个 DBA 的思维和处理方式会受自己的知识面、经验、状态的影响，在处理线上操作时一个人难免有思维死角，造成处理不当甚至线上故障，有一个或者多个同伴一起，能有效处理效率，降低故障率。

第二，工作的质量更依赖于流程制度。有个 DBA 在碰到故障后做了从库和备库的切换，但切换后没有对数据库备份的实例进行调整，导致部署备份的数据库实例和线上的服务发生冲突，引发了线上异常和投诉。随着运维业务发展的需求，而流程、制度是需要团队来构建和执行的。

第三，DBA 集团作战。笔者在2015年上半年，主导了一个 Oracle MySQL 的大型迁移项目，涉及包括 DBA 组11个团队共60多人，历时3个月顺利完成，笔者在项目中承担负责人的角色，需要制定项目计划，协调资源，组织所有负责人、成员完成各自的项目计划；同时带领 DBA 团队开发和完善运维工具，进行数据库迁移和架构升级；并与架构团队配合，评估架构是否满足未来两年业务发展的预期。在这个项目中，DBA 除了自己团队内部配合完成工作外，还要密切配合其他部门完成项目。

在碰到某些比较大的故障、上线时，一个人已无法及时有效地响应所有处理工作，这时需要有一个 DBA 负责人带领团队共同完成。因此我认为数据库运维是团队型工作，团队配合体现在下面几点：

- 团队内部配合共同构建数据库架构与体系、工具、流程制度，提高团队绩效。

- 在同一业务和职责上两名DBA互备。

- 与配合技术团队比如开发、测试、系统运维等岗位密切配合，完成项目。

- 与业务部门配合，完成和业务指标

### 如何做好数据库管理工作

作为职业工作者，我们都希望把工作做好，提升能力，获得更好的回报。那 DBA 应该怎么做好工作，获更好回报呢？我们是应该天天救火，被冠以“救火队长”的美名，还是闲庭信步地陪伴着系统稳定的运行呢？我想大家应该都倾向于后者。我先来讲几个案例。

#### 曾经走过的弯路

笔者也是从小白成长起来的，碰到过一些典型问题，走过一些弯路，可能行业内的同仁也会碰到。

- 纯粹依靠 DBA 个人能力做工作，而不是流程制度

十几年前，能力优秀的 DBA 非常吃香，因为这个岗位技术门槛比较高。优秀的 DBA，能解决各类疑难杂症，最大可能保证企业数据不出问题。但是优秀的人才有限，90%是不那么优秀但是能干活的。招不到优秀人才怎么办呢？

- 备份那么重要，我不会那么背运

实际上 DBA 所做的95%甚至更多比例备份是用不上，而备份需要占用机器和人力资源维护，可能有些团队会不那么重视备份。有位 DBA 在线误删除了 600GB 的业务数据，我们在保留现场后赶紧去找备份，发现这套库本周的备份失效了，原因是备份没有合理的监控，我们只好从上周的备份开始恢复，数据库耽误挺长时间。另外有一个案例，有一份历史上不是太重要的日志数据，虽然已经很久没人用，但在下线数据库时还是保留了当时的静态备份，计划按照公司制度保留三年。在数据备份到两年多时，老板突然转了一封邮件告诉我需要提取这个数据，谢天谢地，数据备份还存在，很快提供给了老板，因为这件事，老板对我的数据备份恢复机制非常满意。

- 监控点越多越好

由于对 MySQL 的理解存在转型的过程，我们的常规监控曾经有50个点，DBA 每天收到几十个报警短信，不堪重负，后来我们将监控点精简至10个，只报出需要处理的。

- 我是技术人员，业务不是我的职责

我以前也对业务不感兴趣，然而经历了挺多大项目，思路有所调整。DBA 是支撑部门，实际上是服务方，如果客户不能满意，我们的工作价值也就打了很大折扣。

- 一门手艺吃遍天下，倚老卖老

在之前公司有位前辈，年龄很大了，挺抗拒新技术学习，同时主动性不强，他是除了部门经理之外资历最久的，尽管经验丰富，但是在经理离职后，并没有提拔他，我感觉是因为主动性不够强导致的。

- 不同 DBA 各自为政，内部的流程、工具百花齐放

随着 DBA 团队所维护系统的增长，工具、流程变得重要了。但是 DBA 团队不是开发团队，因此在开发工具、制定流程时没有标准化，导致程序、流程五花八门，后续的使用和维护成本比较高。

#### 三个数据库运维工作案例

笔者刚到公司供职时，负责业务的数据库以 Oracle 为主，随着业务高速发展，数据库成倍增加，同时也开始由 Oracle 向 MySQL 迁移，实例数由几十个增长到几百个，DBA 团队整天忙于救火，响应各类问题，工作质量也不高，压力还比较大。这时我们开始反思，首先我们的工作主要还是依赖手工完成，工作量超出团队人力上限后，压力增加，工作质量下降；其次没有规范的流程和事后总结，不断出现相同的问题；再次，我们的环境不够标准化，导致出问题的概率增加。这就需要我们标准化环境，自动化日常工作，不断总结、完善流程和制度，我们花了两年来做这些基础建设。消除了我们刚才提到的95%以上的问题。

笔者有一次在做线上操作时手一抖，把表删除了，刹那间心里一沉。这是一个误操作，只是没有引起严重故障，才没有像“某公司宕机12小时”一样上头条。这时笔者先冷静下来，想了一分钟，处理流程，内部通知配合，恢复方案等。然后保留现场，通知应用开发确认影响面，通知系统运维观察服务状态，利用前两天的备份恢复数据，20分钟后，恢复正常，产生2个线上投诉。在这个案例中，可用的备份，故障恢复机制和故障恢复工具，故障处理流程，内部配合流程，都起到了关键作用，将故障的影响尽可能降到最低。

随着技能熟练，工具、制度完善，配合顺畅，DBA 还能怎么提高产出呢？笔者曾经在工作中碰到这样的案例，测试团队不断提出进行线上数据同步至线下测试环境的需求，之前并没有意识到这会影响效率，但是当数据库实例数急剧增加之后，同步成了一个让 DBA 头疼的事情，为了解决这个问题，我们与测试团队负责人沟通了数据同步的几类需求，将需求精简、去重、流程化，实现了一套同步工具，由测试组同学自己进行，降低了该工作90%的时间。

#### 做好数据库运维工作四点建议

通过这几个案例，我们总结下，怎样做好数据库运维工作。

- 首先，制定并遵守制度。

- 其次，在遵循流程、制度的基础上，发挥主观能动性，提高自己在企业工作中的影响力、产出和绩效。

- 再次，我们需要在保证线上的稳定性的基础上，提高效率：

- 最后，我们应该不断学习新技能，加强自我修养，来适应行业和业务的发展。

#### 从哪些方面着手制定制度

我们需要制定完善、合理、可执行的数据库流程、制度和规范，在团队内部以及外部推行，以流程制度为依据，而不是以经验为依据；及时发现、总结、规避流程、制度、操作中的问题，第一时间改进。

我们团队的运维制度里面有这么一个要求，对线上提供服务的数据库切换处理，需要书面和线下指挥系统工程师，双方共同评估。有位高级工程师，工作挺多年，技术也很熟练，他感觉操作对线上影响较小，同时能在短时间内操作完毕，因此在没有通知系统运维工程师的情况下对一台线上数据库做了增加 Redo 日志大小的操作。这个实例提供的是一套核心服务的只读访问，由于操作日志需要停止主从同步，这个期间数据是无法和主库同步的，刚好有几位客户查询自己的业务数据发现不符合预期，产生了投诉。这个案例告诉我们，遵守制度比相信自己的技术能力更重要。流程、制度规范是数据库管理团队的重中之重，制定运维规范可以从下面几个方面着手。

- 上市公司 SOX 404 内控制度

- 主机和操作系统安装配置

- 数据库安装

- 数据库配置规范，参数、运维自动化配置、监控、备份配置、脚本配置
安全策略、授权规范、数据使用规范

- 备份、恢复规范

- 理性检查、巡检规范

- 在线数据库操作规范、应急处理规范

- 故障处理规范

- 开发规范、数据库准入规范

- 批次作业开发、处理规范

#### 遵循制度基础上发挥主观能动性

- 学习并熟悉业务，参与到业务中

- 保证核心 KPI 基础上，做更多的事情，不要本位化

- 在主导、配合工作的时候，以团体目标为导向

#### 保证稳定性同时提高效率

备份重于一切，最可怕的不是故障，而是故障之后发现没有可以恢复的备份。

做好备份有几个要点，第一，可持续恢复；第二，恢复时间可控；第三，备份恢复工具通用高效；第四，能及时发现失败的备份运行；第五，在通用备份的同时，配套特殊备份。

- 做好监控，优秀的监控策略可以极大地减轻 DBA 的工作强度。

做好监控有几个要点，第一，自动部署；第二，核心监控冗余，避免漏报；第三，简化监控点，避免误报；第四，监控分级，不同级别不同报警方式。

- 最大程度地自动化日常工作，解放 DBA 做更重要的事情，95%的工作可以自动化。

- 标准化环境，包括硬件标注、操作系统标准、数据库参数标准、数据库文件标准

#### 不断学习新技能，提高技术和软技能

DBA 应该怎么提高自身的修养和技能，DBA 的工作主要由下面几部分组成：日常支持、优化、规划架构、异常处理、灾难恢复。针对这几点，我们应该持续提高的方面有：

**精通数据库技术**

数据库技术是 DBA 工作的根本，精通 MySQL、Oracle、MongoDB、HBase、Redis 体系架构、维护工具，备份恢复工具、监控体系；熟练使用 Shell/Python/Perl 开发运维工具；熟悉主流数据库架构设计，精通 SQL 编写、优化；精通数据库体系架构及异常处理；对 Linux 操作系统有充分理解，熟悉常规网络、硬件异常的定位；熟悉数据库主流客户端工具。笔者认为，凡是和数据存储相关的技术，DBA 都应该去学习，去了解。

**精通操作系统、硬件运维及网络技术**

操作系统、网络、服务器是数据库服务运行的平台，是运维工作的基础技术，我们需要熟悉甚至精通操作系统、硬件及网络的运维技术。

**制定并遵守制度的能力，培养良好的运维习惯**

尽管我们已经制定了相对完善的运维制度并在团队中推行，但是误操作、操作错数据库、批量误发送命令引发的故障还是会出现。总结了下面几个习惯，与大家分享。

1. 按照运维制度来做线上、线下操作。

2. 使用标记区分线上线下环境。

3. 使用不同权限级别的用户做不同的操作。

4. 及时退出线上环境的登录。

5. 有风险、持续时间长的操作，尽量在服务器上操作，尽量后台带日志操作，而不是客户端，尤其是要避免在第三方客户端操作。

6. 及时恢复系统及周边系统正常的状态。

7. 节假日前后，不做高危操作或重要迁移。

8. 任何有风险的操作，做好备份。

9. 保持悲观，不可漏过任何报警。

10. 在高压下，依然坚持自己岗位的原则和制度。

**良好的软技能和处事方式**

线上数据库的操作需要 DBA 足够镇定，以确保不会出现故障，同时 DBA 必须有决断能力，当面对 A、B 两种选择时，必须能第一时间做出判断，以降低线上的故障时间。同时需要我们足够细致，能在发生问题前把可能的情况以及解决方案考虑好，对发生的报警和故障足够重视。发生问题后能和各配合方良好沟通，组织内部同事解决问题。

**不断更新自己**

互联网时代是新技术高速发展的时代，无论哪个岗位，能做到不断更新自己，才可能立于不败之地。

### 展望

尽管我们团队日常工作运行的已经很顺畅，但在运维自动化及容灾技术方面还有很大改进空间，同时数据服务化和云数据库方面还需要不断探索。运维自动化目前我们还处于工具加平台的阶段，下一步考虑完全平台化以及移动运维平台建设；容灾技术目前我们还采用比较原始的 HA 架构，在发生灾难的时候需要人工介入，有挺高的成本和稳定性影响；数据库技术未来的发展应该是数据服务化，将数据进行包装，而不分 Oracle、MySQL、MongoDB、Redis，对使用人员是透明的；云数据库是未来的发展趋势，可能会改变目前数据库管理员的从业状态，我们会在下一步探索云数据库的建设以及内部使用。