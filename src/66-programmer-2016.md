## 使用 Cocos 开发一款简单的 3D VR 抓钱游戏

文/卞安

>2016年被公认为“虚拟现实元年”，VR 与游戏的结合更成为了行业瞩目的焦点。本文通过一款简单的 3D VR 抓钱游戏讲述了使用 Cocos 引擎来开发 VR 游戏的具体方法。

最近 VR 成为了一个新兴的热点，很多以前从事游戏开发的团队都在关注这个方向。如何在 VR 时代来临之际快速地掌握开发 VR 游戏的方法，这对于很多中小团队来说，是一个需要考虑的问题。

目前市面上有很多 3D 引擎已经开始支持 VR 功能，特别是虚幻、Unity 等引擎对于 VR 这个领域都非常重视，但是国内这几年有大量的手游团队在使用 Cocos2d-x 来开发游戏项目，现有人员的经验对于游戏开发非常宝贵，更何况目前 VR 领域并未出现很好的 CP 盈利案例。短期内贸然转型，放弃现有的引擎编程语言和使用经验，直接转向 Unity 或虚幻，有一定风险。

那么，是否有可能直接使用 Cocos 来开发 VR 游戏呢？

理论上讲，这样既节省了成本，又可以使大量之前所开发的 Cocos2d-x 项目经验得到很好的保留。对于许多传统的 Cocos 手游中小团队来讲，是一个相对比较容易接受的方案。

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb44497aef1.png" alt="图1 《南瓜保卫战》截图一" title="图1 《南瓜保卫战》截图一" />

图1 《南瓜保卫战》截图一

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb4453080c5.png" alt="图2 《南瓜保卫战》截图二" title="图2 《南瓜保卫战》截图二" />

图2 《南瓜保卫战》截图二

随着 Cocos 在 3D 方面的不断完善，使用 Cocos 开发 3D 或 VR 游戏变得现实，这一年来，我和我的团队一直在尝试着用 Cocos 开发一些 3D 和 VR 方面的游戏项目，经过不断地尝试和探索，我们已经用 Cocos 开发出了多款 VR 游戏，并将它们推向了暴风魔镜、87870、乐相大朋、蚁视的内容平台。

比如图1、图2所示的《南瓜保卫战》，它是一款休闲风格的 VR 游戏，算是传统“打地鼠”游戏的 VR 版本。

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb44652e272.png" alt="图3  身处在堆满财宝的房子里" title="图3  身处在堆满财宝的房子里" />

图3  身处在堆满财宝的房子里

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb446d0df4b.png" alt="图4  天下源源不断掉落的财宝" title="图4  天下源源不断掉落的财宝" />

图4  天下源源不断掉落的财宝

<img src="http://ipad-cms.csdn.net/cms/attachment/201604/56fb447561bdc.png" alt="图5  小心不要抓取到炸弹" title="图5  小心不要抓取到炸弹" />

图5  小心不要抓取到炸弹

今天，我以刚刚在暴风平台上线的《2016财宝屋》游戏来讲述一下使用 Cocos 来开发 VR 的具体方法（如图3、图4、图5所示）。

这是一个很有趣的游戏，玩家身处在一个堆满财宝的屋子里，从天上源源不断地落下金钱和财宝，玩家要通过视点瞄准这些落下的财宝进行自动抓取，同时需躲避相应的炸弹，在相应的时间内，抓取到更多的财宝。做土豪的玩法是不是很有意思？

好，下面我们来讲解具体的开发与实现。

在使用 Cocos 来开发这样一款游戏时，它实际上只需要用到以下两个功能类：

精灵类（Sprite3D）：用于加载和显示房间，落下来的各种财宝。

摄像机类（Camera3D）：用于控制主角的视角。

美术在 3ds Max 中将房子和各个掉落财宝的模型制作好以后，我们就可以将其从 3ds Max 中导出为 FBX，并进一步通过 Cocos 引擎中附带的转换命令行工具将 FBX 转换为 Cocos 支持的 c3b 格式模型文件，然后我们将房子加载到 Cocos 的当前 Layer 中。

```
Sprite3D* pHoseSprite = Sprite3D::create(“House.c3b”);
addChild(pHoseSprite);
```

有了这个堆满财宝的屋子后，接下来是创建自身摄像机，并摆放在房子的中心位置。

```
Size visibleSize = Director::getInstance()->getVisibleSize();
Camera* pMainCamera = Camera::createPerspective(60.0, visibleSize.width / visibleSize.height, 0.1f, 100.0f);
m_Maincamera->setCameraFlag(CameraFlag::USER1);
m_Maincamera->setPosition3D(Vec3(0.0, 2.0, 0.0));
m_Maincamera->lookAt(Vec3(0, 0, 2));
addChild(m_Maincamera);
```

然后，CocosVR 会给出相应的方案来使当前的这个摄像机按照 VR 中所用的陀螺仪来进行设置。只需要在最终调用一下开启 VR 模式的接口就可以了，所以摄像机基于最新的 CocosVR 版本将会非常简单地进行分屏和 VR 摄像。

下面就是从天而降的财宝了，我们将这些财宝的模型也一一加载到 Sprite3D 中，并进行简单的逻辑处理，使它们源源不断地从天上落下来，只是在掉到房子地面高度时停下来。当这些财宝下落时，为了避免堆积在相同的位置，需要进行简单的包围盒碰撞，这里可以使用 Cocos 中自带的 AABB 包围盒或者 OBB 包围盒。Sprite3D 自带接口获取 AABB，而 AABB 又可以进一步转化为相应的 OBB。有了这些现成的碰撞盒对象，碰撞处理是非常简单的，只需要通过它们的相交函数是否返回 true 就可以了。

紧接着就是要处理视点抓取财宝了，为 Layer 调用每一帧的 update 函数，从摄像机的位置沿观察方向建立一个射线：

```
Ray tRay(_camEyePos, _camLookAtDir);
```

通过这个射线的相交函数与各个财宝的包围盒进行碰撞检测，就可以知道是否应该抓取相应的财宝啦！抓财宝时播放主角的抓取动作就可以了，抓取完后再生成一个新的财宝放在天上随机的位置继续下落，就可以发现永远有捡不完的财宝。

```
//开始VR兼容模式
Director::getInstance()->setVRModeEnabled(true);
```

这样的一个游戏，实际上用 Cocos 开发是非常方便的。当然也可以非常方便地将它扩展成不同的玩法，对于广大移动开发者来说，Cocos 的所有经验仍然有效。相信随着 CocosVR 的不断成熟，会有越来越多的开发者喜欢上使用 Cocos 来开发 VR 游戏。

在此，总结一下自己在使用 Cocos 进行 VR 开发时遇到的一些陷阱或需要开发者们注意的问题：

在立项时要考虑清楚游戏的引擎需求，比如是否有野外地形和场景光影烘焙？是否有场景编辑器的需求？因为 Cocos 目前的版本在野外地形的编辑器支持上有一定缺失，如果没有较强的自研工具能力，暂时不宜做场景太大的项目。

在摄像机的控制和操控方式上，要多尝试。因为 VR 现在还属于一个尝试期，所有的尝试都能成为有益的经验。有时候头晕的问题，只是改一下摄像机的控制方式就可以解决。

操控设备和 VR 眼镜 SDK 接入是很重要的事情。所以在实际项目开发过程中，要多与厂商沟通，如果对方没有提供 Cocos 的相关支持开发，要尽可能选择支持 Android 系统相关协议的设备。不过 Cocos 也正在快速地与各硬件厂商进行 SDK 对接，其中比较知名的厂商，如 Nibiru（南京睿悦）的系列设备也都有 Cocos 的 SDK 提供下载。

最后，就是当你的游戏完成了，提交到相关渠道，或许会发现没有收益，这对没有资金支持的团队来讲可能是最打击信心的事情。所以，对于广大的中小团队来讲，保持一个较低成本，尽可能地开发多一些小游戏并迅速推出，在当下比孤注一掷地开发一款大作要现实得多。

总之，VR 时代来，信心和乐观地参与比其它事情更重要。

至于金钱数量的处理和显示，这些对大家来说应该是很简单，笔者就不再赘述。

最后开启 VR 模式，就可以打包在 VR 眼镜上观看了。