## 直播连麦技术解析

文/毛宗武

所谓直播连麦技术，即主播在直播过程中，有观众需要和主播进行实时音视频交流，而其他非连麦观众可以观看主播与连麦者之间的交流过程。AnyRTC 早期是一家做视频会议和实时通讯云平台的软件公司，在发展的过程中积累了丰富的音视频实时通讯经验，特别是在基于 WebRTC 的解决方案上有很多成功案例；而现在恰逢直播元年，这些经验和成功案例在视频直播中同样受用，最直接的落地就是 RTMPC 直播连麦引擎；所以说 AnyRTC 的直播连麦技术是传统直播技术与 RTC 实时通讯技术结合的产物，两者相辅相成谁也离不开谁。

现在使用手机进行视频直播的相关 App 已经快达到300个，可以说移动视频直播行业发展的如火如荼，但纵观整个直播市场，大多数还是以单向的主播模式+文字互动的形式居多，只有几家较大规模的 App 拥有直播连麦功能；直播连麦的功能并非不可或缺，但是随着直播 App 的进一步发展，连麦技术必将成为直播的闪光点，所以本文将对直播连麦技术进行一次技术解析。

本文讨论的直播连麦技术均建立的 RTMP 协议的直播系统基础之上，不适用私有协议或 UDP 直播等解决方案。

### 直播连麦技术

常见的直播连麦技术有以下几种模型：

- 双流模型：这种也是最简单的模型，主播和连麦的用户同时发布一路流，所有观看的用户同时拉两路流。

- P2P 双流模型：主播和连麦的用户同时发布一路流同时建立 P2P 通道，所有观看的用户同时拉两路流。

- P2P+ 模型：相比 P2P 双流模型，这种模型更为复杂，主播和连麦的用户建立 P2P 通道，主播端将连麦用户的音频图像与本地合成后发布一路到给所有的观看用户。

- 中心节点模型：这种模型是最为复杂的，主播和连麦的用户将视频发布至中心节点(MCU)，服务端进行处理之后将混合流推至直播服务器。

### 双流模型

#### 技术解析

双流是最简单的模型（图如图1所示），主播和连麦者均发布一路流到直播服务器，主播与连麦者之间相互拉取对方的流；观看者同时拉取直播和连麦者的流，这样整个连麦的流程就完成了。这种模型最主要的缺点就是主播和连麦者之间无法进行真正意义上的实时互动，因为直播协议 RTMP 并非强实时性协议，市场上的直播服务产品有做的好的可以控制在3秒以内，甚至可以做到1秒以内，但是在实际应用环境中，由于受到网络环境等因素的影响，很难达到1秒以内的强实时性要求，所以这种模型还是建立在理论之上，建议开发者在实际应用场景中尽量规避这种模型。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c53a6684f16.jpg" alt="图1  双流模型图" title="图1  双流模型图" />

图1  双流模型图

#### 优缺点

模型简单，实现简单，维护简单；增加直播服务器压力；增加网络带宽消耗；连麦实时性低，容易受网络抖动影响；主播与连麦者音视频难以保证同步，观看者体验较差。

### P2P 双流模型

#### 技术解析

P2P 双流模型是双流模型的升级版（图如图2所示），此模型主要为了解决双流模型主播与连麦者之间互动实时性问题。主播和连麦者均发布一路流到直播服务器，主播与连麦者之间建立 P2P 音视频通道，观看者同时拉取直播和连麦者的流；主播与连麦者之间建立的是 P2P 音视频通道，此通道的延时可控制在毫秒级，实时性非常高可保证主播与连麦者之间的通畅交流。目前市场上基于 P2P 的解决方案一般都采用 WebRTC 技术，此技术是谷歌的开源产品，功能齐全稳定性高，非常适用于实时通讯的应用场景；所以只需要在原有的推流拉流的解决方案中增加一个 P2P 方案即可完成此模型。P2P 双流模型虽然解决了主播与连麦者直接的实时互动问题，但是他的缺点还是显而易见的，这种模型同样会增加直播服务器的带宽，同样无法对观看者拉取的两路流进行音视频同步。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c53ab986495.jpg" alt="图2  P2P双流模型图" title="图2  P2P双流模型图" />

图2  P2P 双流模型图

#### 优缺点

模型简单，实现较复杂；增加直播服务器压力；增加网络带宽消耗；增加 TURN/STUN 服务器消耗；连麦者之间使用 P2P 通道，实时性高；主播与连麦者音视频难以保证同步，观看者体验较差。

### P2P+ 模型

#### 技术解析

P2P+ 模型是以上两种模型的进化版（图如图3所示），主播与连麦者之间建立 P2P 音视频通道，主播端将连麦者的音视频与本地的音视频进行合成，然后将合成之后的音视频流推到直播服务器，观看者只需要拉取主播的直播流即可。此模型解决了双流问题，观看者只需要拉取一路视频流，节省了网络带宽消耗；同时主播端对音视频进行合成，可以保证主播与连麦者直接的音视频是同步的，这样呈现给观看者的音视频也非常自然，不会受到其他因素影响。但是这种模型的缺点就是会增加主播端的资源消耗，可能会影响到直播源的质量。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c53b88d7b44.jpg" alt="图3  P2P+模型图" title="图3  P2P+模型图" />

图3  P2P+ 模型图

#### 优缺点

模型较复杂，实现复杂，维护成本低；增加主播端复杂度；增加 TURN/STUN 服务器消耗；节省直播服务器带宽流量；连麦者之间使用 P2P 通道，实时性高；主播与连麦者音视频同步，观看者体验较好。

### 中心节点模型

#### 技术解析

中心节点模型最为复杂（图如图4所示），因为此模型中引入了 MCU（Microcontroller Unit）服务器，主播和连麦者与 MCU 进行音视频通讯，MCU 将主播和连麦者的音视频合成之后推到直播服务器上，观看者拉取这一路流即可观看连麦直播。此模型的优点与 P2P+ 模型类似，但比 P2P+ 模型更能保证直播的质量，主播端的复杂度明显降低；但是由于 MCU 的引入此模型的实现复杂度极高，不建议中小团队尝试这种模型。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c53bcacd2b0.jpg" alt="图4  中心节点模型图" title="图4  中心节点模型图" />

图4  中心节点模型图

#### 优缺点

模型复杂，实现复杂，维护成本高；增加 MCU 服务器；节省直播服务器带宽流量；降低主播端复杂度；连麦者之间使用实时服务中转，实时性高；主播与连麦者音视频同步，观看者体验较好。

### 总结

本文讨论了这几个比较常见的模型，各自的优缺点都非常明显，当然市场上还有其他一些技术解决方案，但是所谓技术解决方案并没有一个是完美的，针对实际的应用场景来匹配解决方案也是必需的。

综合各种指标，在这几个解决方案中笔者推荐使用 P2P+ 模型，此模型虽然会增加主播端的复杂度，但是可以有效降低整体方案的复杂度，提升直播连麦的品质，在实际的案例部署中的实际效果也是最好的，值得推荐。