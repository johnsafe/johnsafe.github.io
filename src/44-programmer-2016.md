## 无人机的 GPS 欺骗及防护措施



文/袁舰

近两年无人机市场非常火热，大疆创新、零度智控、极飞科技等一批无人机厂商不断推出新品、获得融资。整个无人机市场蓬勃发展，而它们的安全问题却依然不容忽视。其中 GPS 的安全性又成了无人机安全的主要问题。

2015年美国特勤局发现了坠落在白宫地面上的小型无人机，引起轩然大波。虽然之后证明该无人机是误入白宫，但这却让特勤局非常难堪。为确保不会再发生此类事件，无人机厂商被强制要求更新固件，禁止在该区域内飞行。之后，App 上的世界地图出现了许多大大小小的禁飞区。

然而这样的措施并不能完全禁止无人机在禁飞区飞行。无人机检测是否处在禁飞区，完全依赖 GPS 定位，通过 GPS 定位得到位置信息，与禁飞区位置对比判断是否处于禁飞区。全局性地分析 GPS 通信链路，能对 GPS 定位可能存在的安全隐患有更好的把控。首先，GPS 信号从 GPS 卫星发射出来，劫持卫星是一个好想法，但却难以实施。GPS 卫星除了民用外，更重要的是军事用途，这意味着极其严格的防御措施。接着，GPS 信号在空间中传播，信号可能在此阶段中被伪造、篡改。最后，GPS 信号被接收后，经过处理后得到位置信息传送给无人机主控。在传输的过程中这些信息依然可能被篡改。因此，本文就硬件和 GPS 信号两方面介绍无人机的 GPS 欺骗。

### 硬件层面

#### GPS 模块
从硬件层面入手，就不得不提到无人机内部的 GPS 模块。如图1所示，是无人机内部拆卸下来的 GPS 模块。GPS 模块的设计一般都是采用 GPS 芯片厂商给出的电路方案或者基于方案此进行调整。它主要包括了天线、芯片及外围电路、接口部分。GPS 模块接收信号，通过滤波、解调、放大等一系列手段并进行处理，最后得到自身的位置、海拔、加速度等信息。通过外部接口把这些信息传送给无人机主控使用。然而通过接口传输信息到无人机主控的过程中存在数据被篡改的可能性。它们之间的通信存在被劫持的可能性，就是中间人攻击。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d551f06d4b4.png" alt="图1  GPS模块" title="图1  GPS模块" />

图1  GPS模块

#### 数据格式
要得知其中传输了什么数据，就要先看该模块用了什么芯片。查看模块中芯片的生产厂商和型号，在网上找到对应的数据手册。接着分析接口的类型，如 UART、SPI 都是常用的接口。无人机的内部数据传输并没有类似银行 POS 机那样经过加密，这也使中间人攻击成为可能。因此，数据格式的分析也成了篡改 GPS 信息的关键环节。

如图2所示，SYNC CHAR1 和 SYNC CHAR2 是数据的包头，所有数据包都是固定以这两个字节开头的。CLASS 是该包数据属于的类型，ID 则是该类型中的一个更小的分类。LENGTH 告诉我们负载所占据的长度。接下来的 Payload 则很明显是该数据包携带的有效数据。最后两个字节 CK\_A 和 CK\_B 是整包数据的校验码。如果修改了该数据包中的其他数据一定要记得重新依据手册中的算法再次产生校验码，否则可能会造成主控不识别的情况。对传输的数据做劫持，需要修改的就是传输 GPS 位置信息的数据包，对其中 Payload 的经纬度进行修改。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d55662ed809.jpg" alt="图2  数据格式" title="图2  数据格式" />

图2  数据格式

所有数据包都是按照以上格式来传输的。这样的数据格式也是其中一个比较典型的例子。完成了理论部分的研究，接着需要用实践来检验理论的正确性，因此做出相应的硬件必不可少。

#### 硬件工具
如图3，该数据劫持模块主要完成对 GPS 模块传输到无人机主控位置信息的修改。它主要具备两个接口，一端接在 GPS 模块的接口上，另一端接在无人机的主控上。GPS 模块和无人机主控之间的通信都需要通过该模块。这样每次 GPS 模块上传的正确位置信息都会被这个模块修改，因此也就能够把原本的禁飞区位置修改到非禁飞区内，实现对禁飞区限制的破解。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d556b4c0b89.jpg" alt="图3  数据劫持模块" title="图3  数据劫持模块" />

图3  数据劫持模块

在修改位置信息的过程中也衍生了一些不同的修改方式，可以设定为不改变任何传输数据的直接模式，也可以设定为不传输任何数据的阻断模式。当然，也可以通过对其中位置的修改，让无人机出现在地图上的任意位置。这样做虽然可以很容易达到突破禁飞区的目的，但也产生了一个问题，就是无人机一直处于一个固定的位置，它的自动返航等功能将无法使用。自动返航是一个很有用的功能，它能帮助无人机玩家让飞远了的无人机自动回到起飞的位置。无人机在启动电源时自动搜索当前所处的位置并保存下来，玩家在操控无人机飞远后，无人机检测到的当前位置变化了，当按下自动返航键时会根据起飞位置和当前位置差自动飞回。这其中是需要不断检测当前位置的，固定的位置欺骗会让无人机认为自己一直处在起飞位置造成无法返回到真实的起飞位置。通过所谓的偏移模式，即在当前位置的基础加上固定的偏移距离，既能够突破禁飞区的限制，又能够非常好地保留类似自动返航这样的功能。因为每次都对数据添加了固定偏移距离，所以就能突破禁飞区限制。另外，每次得到的都是实时的相对位置，自动返航类似的功能也能够很好地保留。这可能是目前最好的禁飞区破解方式。

既然有这么多模式可以修改，还有不同的替换位置坐标，还有不同的偏移量设定，每修改一次就拆机一次就十分麻烦。于是有了配套工具，如图4所示的劫持控制器。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d556edac0a4.jpg" alt="图4  劫持控制器" title="图4  劫持控制器" />

图4  劫持控制器

通过劫持控制器的无线模块可以对植入到无人机中的模块进行设定。它可以非常方便地对 GPS 数据劫持的方式进行修改，甚至欺骗位置的经纬度也可以直接输入更改。

### 信号层面

#### GPS 信号简介
GPS 卫星主要发射两种信号。一种是在1227.60MHz 发射的10.23MHz 带宽信号，是军用信号。这种信号使用了高强度的加密措施，为美国军方专用。破解不是不可能，只是复杂度很高，也很难实现欺骗攻击。另一种所谓的民用 GPS 信号是在1575.42MHz 发射的1.023MHz 带宽信号。民用 GPS 信号的标准是完全公开的，各个芯片厂商也是根据该标准设计 GPS 芯片。除了美国军方以外，其他人都只能使用开放度非常高的民用 GPS 信号。消费级市场上的无人机使用的芯片也不例外。

#### 重放攻击
因为民用 GPS 信号协议标准完全公开，而且没有任何的加密措施，所以重放攻击成为了一种典型的 GPS 欺骗方法。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d5573c4f559.jpg" alt="图5  硬件连接示意图" title="图5  硬件连接示意图" />

图5  硬件连接示意图

如图6所示为通过 USRP B210 为主，配合 LNA、电源、天线等搭建的硬件平台，可以录制 GPS 信号，并通过 bladeRF 对录制到信号重放。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d5577956e1d.jpg" alt="图6  USRP B210录制GPS信号" title="图6  USRP B210录制GPS信号" />

图6  USRP B210 录制 GPS 信号

如图7是 Nexus 5的 GPS 定位截图，手机从重放的 GPS 信号中得到了位置和时间信息。右上角是手机的系统时间，而右下角是录制 GPS 信号的时间。同时 GPS Status 显示 3D Fix 定位成功。这些说明了录制的 GPS 信号重放成功，达到了预期的欺骗效果。但是这种欺骗存在一个弊端：如果需要把目标欺骗到另外一个地方，需要提前到该地点录制一段 GPS 信号，非常不便。由此也就产生了定制 GPS 信号的想法，而不是简单地录制和重放。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d557b7ac6e7.jpg" alt="图7  GPS信号重放效果图" title="图7  GPS信号重放效果图" />

图7  GPS 信号重放效果图

#### 模拟 GPS 信号样例
如图8所示，左边是在拉斯维加斯得到的五角星形移动轨迹图，右侧则是在北京得到的五角星形移动轨迹图。可以看到五角星形都非常规则，即使是实地运动也很难得到这样的效果。很明显，这是利用 GPS 信号定制欺骗方式得到的运动轨迹图。通过不断伪造指定的坐标点得到规则的运动轨迹。然而并非导航方面的专家，如何做到这些的呢？答案是运用 USRP、bladeRF、HackRF 之类的软无线电平台 DIY 一个 GPS 模拟器。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d557fb176ec.jpg" alt="图8  地图上绘制五角星" title="图8  地图上绘制五角星" />

图8  地图上绘制五角星

#### GPS 基本原理
如图9所示，中间一条弧线代表了地平面，每个卫星发射的 GPS 信息经过不同的路径到达 GPS 接收机。经过的路径也各不相同，导致到达接收机的延迟时间也不相同。每个卫星连续不断地传送信息，包括时间信息、精确的轨道信息（星历）、全部 GPS 卫星的健康参数和粗略的轨道信息。接收机通过测量信号的传送时间，计算出距离每颗卫星的距离。接收机使用几何三角测量，并根据这些卫星的距离和位置确定接收机的位置。一般情况下，GPS 接收机搜索到不少于四颗卫星时能够取得比较好的定位效果。在一些特殊的情况下可以使用更少的卫星定位。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d558420ee1c.jpg" alt="图9  GPS原理示意图" title="图9  GPS原理示意图" />

图9  GPS 原理示意图

当然，除此之外还需要对 GPS 信号的数据结构进行分析，以便模拟出同样格式的信号。具体的信号格式需要参考 GPS 信号的公开标准。

#### 多普勒效应
另外一个需要考虑的重要问题是多普勒效应。当做 GPS 相关实验的时候，由于没有考虑到多普勒效应，导致欺骗信号对手机等接收机的欺骗并没有成功。简而言之，多普勒效应就是波源和观测者之间的相对运动导致波长变化了。当两者越来越接近的时候，波长变短了，而两者远离的时候，波长变长了。反映到 GPS 的接收问题上，卫星和地球的相对运动导致延时变化了。如果卫星朝着远离接收器的方向运动，延时会增加；反之，如果朝着靠近接收器的方向运动，延时会减少。而延时是求解位置信息的关键参数。因此，模拟 GPS 信号需要考虑到这些问题。

#### 模拟 GPS 信号
获得星历数据有两种方式。一种是从 CDDIS 下载星历数据，然而这只能得到过去的星历数据。另外一种是使用“gnss-sdr”开源软件配合软无线电硬件接收实际的 GPS 数据得到最新的星历数据。得到的“GSDR*”文件是解码过的星历数据，它采用了标准的 RINAX 格式。另外，需要编写 Matlab 代码完成读取星历数据、选择星历数据、决定卫星的可见性、产生报文等工作。按照 GPS 公开标准把子帧转换成无线电波。

#### 欺骗样例
图10是模拟 GPS 信号欺骗 Nexus 5的效果。右下角的时间信息为伪造 GPS 信号的时间信息，而右上角为手机的系统时间。这证明了这部手机的 GPS 信号被欺骗了。中间绿色的柱状图表示各个卫星信号的强度，图上所示的卫星信号强度达到了惊人的一致。而实际的 GPS 信号因为到达接收机的距离不同，会产生不同程度的衰减，得到的卫星强度差别也会比较大。实验发现，当手机打开时间自动校准的时候，手机上的系统时间会被 GPS 信号内含的时间信息更新。如果手机接收到的是模拟 GPS 信号，系统时间也会被更改成错误的时间。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d558e489575.jpg" alt="图10  GPS定位效果图" title="图10  GPS定位效果图" />

图10  GPS 定位效果图

无人机的地理位置是在北京，如果在室外，定位到的位置会是北京，而且无法正常起飞，因为它处在了禁飞区内。但通过模拟的 GPS 信号，可以把无人机欺骗到夏威夷，如图11，从而实现禁飞区的解锁。如果无人机已经正常起飞，用位置是禁飞区的信号对其欺骗，该无人机误认为自己处在禁飞区就开始自动降落。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d55c06b3c72.jpg" alt="图11  禁飞区失效" title="图11  禁飞区失效" />

图11  禁飞区失效

对于这种完全模拟出真实 GPS 信号的方法，对目前的 GPS 接收器的欺骗是普适的。汽车也不例外，如图12是一辆比亚迪 · 秦的汽车被欺骗定位在了纳木错湖中心。这是一辆普通汽车几乎不可能到达的位置。

<img src="http://ipad-cms.csdn.net/cms/attachment/201603/56d55c52654ce.jpg" alt="图12  比亚迪·秦的GPS导航" title="图12  比亚迪·秦的GPS导航" />

图12  比亚迪 · 秦的 GPS 导航

### 防护措施及展望

一般情况下，GPS 拥有最高的优先级。如手机也可以通过蜂窝网大致定位，不过系统会认为 GPS 定位是最精确的，优先利用 GPS 定位的结果。除了位置信息以外，GPS 信号内也包含了时间信息，当手机打开时间自动校准的时候，手机时间会根据 GPS 时间做出更新。因此不论是位置还是时间都有被欺骗的可能。建议采用多模定位，如格洛纳斯、北斗定位系统，可以有多维度的参考。另外，可以考虑把蜂窝网络和 WIFI 位置也纳入参考对象。GPS 接收机的主要功能都是在 GPS 芯片内实现的，可以在芯片内加入一些有效的算法检测欺骗。例如各个卫星信号强度都几乎完全一样，就很有可能是伪造的 GPS 信号。当然，主要问题还是在民用 GPS 信号未加密且完全公开上。从根本上解决该问题，需要在指定 GPS 信号协议的时候添加有效的加密措施，例如数字签名。

硬件层面上主要问题出现在 GPS 模块和主机之间的通信没有任何加密措施。厂商需要加强模块间数据通信的加密，避免数据在传输过程中被劫持。

GPS 是全球第一个定位系统并在全世界广泛应用，而且具有小体积低成本的优势。目前虽然存在许多问题，但是它仍然在不断更新。相信这些安全问题在将来会得到改善。