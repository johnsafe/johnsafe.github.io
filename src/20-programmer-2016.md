## 深入理解自动化测试

文/林汉琛

伴随着软件产品迭代周期的加快，以及由此产生的对产品回归测试要求的加大，使自动化测试快速进入大家的视野，特别是互联网、云计算、大数据等各大新兴产业，如今人们对自动化测试的认知也由过去的一无所知，变成百家争鸣，当然仍然还有对自动化测试存在一定误解的。本文主要带你全面认识自动化测试架构，以及分享在虚拟化和云计算领域的自动化测试经验。

### 什么是自动化测试？

从狭义上讲，我们将自动化执行测试用例称之为自动化测试，或者更准确地说，称之为“半自动化测试”。因为如果只是自动化执行测试用例，其实并不能真正地解放手工劳动。而只有将测试过程中的虚拟机置备，环境搭建，软件安装，测试结果记录、通知等流程通过自动化方式串联起来，才可以称之为“全自动化测试”。

如图1所示，开发人员把代码提交到版本库之后，测试监听器将会监听和打包代码，触发自动化测试框架进行整体测试调度和执行，最后测试人员会收到邮件或微信形式的报告，然后再由测试人员进行 Bug 的确认和复核，然后提交到 Bug 系统。简而言之，就是“一键运行，无人值守”。 

<img src="http://ipad-cms.csdn.net/cms/attachment/201601/568a30b3c687f.png" alt="图1  全自动化测试解决方案" title="图1  全自动化测试解决方案" />

图1  全自动化测试解决方案

### 如何实现自动化执行测试用例

#### 自动化测试方法
首先来看看，实现自动化测试都有哪些方法，以及各自的优缺点。自动化测试可以分为五类，分别是录制回放、脚本、数据驱动、关键字驱动和流程驱动，如图2所示。

<img src="http://ipad-cms.csdn.net/cms/attachment/201601/568a30d596d16.png" alt="图2  自动化测试方法对比" title="图2  自动化测试方法对比" />

图2  自动化测试方法对比

#### 自动化测试的操作与验证
从操作的维度上来看，自动化可以分为四类，分别是坐标定位法、外设模拟法、元素定位法和接口调用法。

### 自动化测试框架设计与开发

上面从战略和战术两个层面分析了自动化测试的方法，但要真正实现落地，还缺少一个灵魂角色，那就是自动化测试框架。正所谓，工欲善其事，必先利其器。设计一款适合于企业自身实际需求的自动化测试框架，对于实施和开展，会起到事半功倍的效果。

#### 自动化测试框架
曾有位朋友把自动化测试框架形象地称为“生态系统”，生态系统最大的特点是能量流动、物质循环、信息传递。正如自动化测试框架所实现的：自动拉取开发源码→构建→部署环境→执行测试用例→形成测试报告→触发提醒，接下来又是下一轮新的循环。整个过程，跟生态系统一样伴随着流动、传递、循环。对于一个生态系统，我们不需要去告诉它做什么，而只需要让它运转起来就足够了。

#### 自动化测试框架的组成
如图3所示，一个自动化测试框架基本应该由如下部分组成。

<img src="http://ipad-cms.csdn.net/cms/attachment/201601/568a312bcc22f.png" alt="图3  自动化测试框架架构图" title="图3  自动化测试框架架构图" />

图3  自动化测试框架架构图

1. 自动化测试构建器：负责自动对版本控制库中的源码进行打包，可以直接调用版本控制工具，如 SVN 或 Git 的接口或命令，也可以调用持续集成工具接口，如 Jenkins 进行打包。
2. 测试监听器：负责监听源码是否更新或者是否有新的 Build 生成，之后促发测试调度器进行测试执行调度。
3. 测试调度器：负责整体测试调度，是自动化测试框架的核心组件，整体测试的编排，测试的执行，以及测试之后的结果收集，报表生成，发送通知都是由调度器负责。
4. 测试执行器：负责测试执行工作，通过反射机制，根据测试配置文件，执行具体函数，它由环境部署引擎，UI 自动化引擎和接口自动化引擎组成。
5. 环境部署引擎：负责测试环境部署、相关事宜、涉及虚拟机置备、服务安装、中间件安装、产品安装等一系列测试脚本执行的前期准备工作，也可称之为“Test Ready”。因为测试环境的部署可能需要在 Windows 或 Linux 两种不同的服务器操作系统上面执行，所以需要跨 OS 的驱动实现对远程控制和通讯，以保证部署脚本可以在不同 OS 上执行。
6. UI 自动化引擎：负责 UI 自动化测试脚本的执行，提供 UI 自动化测试常用库，对 B/S 类应用来讲，需要跨浏览器支持，保证 UI 自动化脚本可以在不同浏览器上执行。UI 自动化引擎的存在，封装了基础的 UI 操作，跨浏览器的支持，可以让 SDET 在编写脚本过程中，更多地关注测试逻辑编写，操作与逻辑的分离也极大地提高的脚本编写的速度，降低了后期维护成本。
7. 接口自动化引擎：负责接口自动化测试脚本的执行，提供接口自动化测试常用的库，最常见的接口，通常是 REST API，所以会封装基础的 Get、Post、Delete、Put 等 HTTP 请求操作。针对传统桌面应用，需要额外封装产品接口调用。接口自动化引擎的存在，会降低脚本编写的复杂度，同时降低测试逻辑和接口的耦合度，降低后期脚本维护的成本。
8. 日志模块：负责日志的收集和持久化，日志的收集对于测试脚本的排错以及测试结果的追踪都非常重要。同时提供基本日志处理函数与操作，降低脚本编写过程中日志处理的复杂度以及标准化日志输出。
9. 报表生成器：负责形成不同格式的测试报表，不同的团队，不同的受众希望看到报表往往不尽相同，因此报表生成器会保存不同模板，而不同模板对于同一个日志文件会形成不同的展示风格，报表生成器的出现实现了日志数据与呈现方式的分离。
10. 通知触发器：负责测试结果的通知，测试完成并形成报表之后，需要第一时间通知相关人员，一般是测试执行人员，测试经理，开发经理等。所以自动化通知也是自动化测试框架中不可或缺的一部分，但考虑到通知的差异化，设置至少两种通知方式，常规的邮件通知和人性化的微信通知，特别是当自动化测试在下班时间自动触发的场景下，微信时效性更强，因为很少人会在下班之后，还盯着邮件，但是还需要让他们及时知道结果。
11. 配置接口：负责配置文件的管理，JSON 保存测试数据和操作（函数调用），Config 保存操作对象（通常针对 UI 自动化），XML 保存自动化框架级别的配置。
那除了架构本身，作为一个针对于测试的框架，需要涵盖哪些功能呢？

#### 自动化测试框架的功能
对于自动化测试框架和传统的软件的设计，在功能点的设计和思路上还是有差异的。接下来，我们从测试的角度出发，一起来谈谈自动化测试框架的功能特性。

1. 支持测试数据、操作对象、流程分离。
按照上文数据驱动、关键字驱动和流程驱动的相关理念，自动化测试框架必须能够有效分离测试数据和操作对象，并实现对测试流程可定制和调整的目标。这是自动化测试框架设计过程当中需要考虑的一个核心功能。

2. 支持测试粒度划分。
测试一般会分为测试集（Test Suite）、测试用例（Test Case）、测试步骤（Test Step）三级，测试集包含了一组相互关联的测试用例，测试用例包含了某一功能点相关的一系列测试步骤以及测试期望结果。从脚本的角度来看，一个测试用例一般对应于一个类，一个脚本文件，或是一个 Module，而测试步骤和验证分别对应的是函数或方法。自动化测试框架必须支持对不同粒度的测试调用，既要支持联合执行，也必须支持独立执行。

3. 支持执行顺序多样化。
对于同一测试集中的用例，一般是相互依赖和关联的，只能通过串行的方式顺序执行，同样，测试用例中的步骤亦是如此，但是对于不同测试集中的测试用例之间，是没有依赖关系的，所以需要支持不同测试集之间以并行的方式同时执行，用以节省时间。

4. 支持测试间的值传递。
同一测试集下用例之间，同一用例下的步骤之间，数据输入和输出经常是有关联的，比如，用例A中测试步骤1的输出，可能会成为用例B中测试步骤2的输入，所以框架必须支持步骤之间的传值或引用。

5. 支持测试间的依赖。
同一测试集下不同用例之间的依赖，和同一测试用例下不同步骤之间的依赖是测试中的常见问题。比如，用例 A 中步骤1是登录操作，所以它的失败可能导致其他测试用例没有执行的必要。关键步骤1失败之后，框架应该支持自动跳过其他用例和步骤，并在 Log 中做好标识，表明由于关键任务失败，导致其他任务 Skip。

6. 区分对待测试异常。
对于软件开发来讲，异常就等同于 Bug，但是对于测试来言，有时候异常却是 Pass，而不是 Failed。比如，点击一个按钮，如果点击不成功会抛出异常，那这属于测试通过，还是失败？如果是正向，测试失败，如果是反向，则为测试通过。例如，当某个必选项没有填写的时候，提交按钮就处于未激活状态，点击操作的期望结果就是抛出异常，那么抛出异常就是 。Pass。所以，不要捕获到异常就记录测试失败，而需要动态判断。

7. 支持测试实时执行。
通常来讲，测试任务是顺序执行的，被依赖任务会先于依赖任务执行，当被依赖任务执行之后，它的返回值会被保存在内存之中，作为下一个依赖任务的输入。通常这是一个很正确的处理方式。但是，如果这个被依赖任务是获取。Token 的操作，而这个 Token 是有过期时效的，而当依赖任务需要用这个 Token 时，有可能 Token 已经过期，测试会因使用了过期 Token 而失败。所以，自动化测试框架必须有实时执行被依赖任务的功能。

8. 支持静态测试数据的共享。
测试数据分为静态和动态两类，动态数据是在实际执行过程中产生的，而静态数据，是指测试执行之前产生的，不随执行变化而变化的数据。自动化测试框架至少应该实现静态数据的无差异化和差异化共享。例如，有10个用例，其中9个都用到同一静态数据，叫“用户名”，那么可以在全局测试数据文件中配置一个称为 Username=SameUser 的键值对，这样9个用例可以无差异化共享这个变量。但有1个用例虽然也用到了用户名，而是它需要的是 Username=DiffUser，这时就需要通过作用域进行差异化共享了。

9. 支持后台服务器验证。有测试经验的 SDET 都会知道，很多时候，前端验证需要通过对后端服务器和数据库的查询来实现。这意味着，你的框架需要支持远程访问和远程控制的功能。

#### 自动化测试框架的作用
1. 简化脚本开发难度，通过大量辅助类库，工具和功能组件，让 SDET 专注于测试逻辑的编写；
2. 降低脚本维护成本，通过数据，操作对象的分离，极大降低了产品变更所导致的脚本维护工作量；
3. 优化自动化测试流程，通过数据、操作对象的分离和流程的可配置化，让测试执行人员可以按需执行。

#### 云计算产品测试案例分析
这里通过一个简单的小案例，和大家一起来分析下云计算产品自动化测试的经验。
##### **背景**
在虚拟化向云计算过渡的大趋势下，传统虚拟化厂商 C 决定转型，把原有的虚拟化应用和桌面服务，通过自主研发的 SaaS 平台对外提供云服务。SaaS 的底层 IaaS 和 PaaS 架构使用业界知名的公有云 A，开发模式为敏捷开发，2周一次迭代，产品架构完全基于 Restful API，环境部署随时随地进行。
##### **测试分析**
在云计算产品的新背景下，测试所面临的困境如下。
1. 在云计算产品初期，没有形成界面，只有接口。虽然手工人员可以通过 Postman 等接口测试工具来进行产品测试。一方面，诸如此类的接口测试的工具并不是万能的，就 Postman 而言，它并不能支持全部的 Header，但是就接口测试本身而言，Header 的测试又非常重要。另一方面，当测试规模达到一定程度之后，使用 Postman 的效率很低。
2. 云计算产品迭代周期的加快，如果单纯增加手工测试人员，除了会导致人力成本的线性增加之外，还会增加团队沟通的成本，更重要的是手工测试人员的主观性所带来的测试步骤不一致，很容易造成测试点遗漏。从管理角度而言，手工测试人员的真正价值，应该是投入到新功能的测试上面，而不是被海量回归测试拖入泥潭。
3. 环境部署的即时性所导致的传统手工部署方式已经跟不上开发和测试的脚步，自动化部署演变为一个新的需求。
4. 云计算产品快速迭代的场景下，传统的人工汇总测试数据的方式是对资源和时间的一种极大浪费。
5. 传统模式下，开发人员完成代码打包之后，测试工作才能开始进行。但是，完成代码和开始执行测试这两个时间点通常会存在一个时间差。开发会在第一天结束的时候完成代码，而测试则是在第二天开始的时候执行测试，这期间有一夜的时间差，无形中被浪费了。 

##### **自动化测试方案**
在人员分工上，由1个框架开发工程师负责整体自动化测试框架的研发和维护，N 个 API 测试的 SDET 负责对应服务的 API 自动化测试脚本研发，N 个 UI 测试 SDET 负责 Web 前端自动化测试脚本研发，一个手工测试 Lead 负责和开发沟通产品服务细节，编写测试用例，N个DevOps 负责开发自动化部署脚本并提供测试入口，自动化测试框架调用部署脚本实现按需自动化部署，按全新安装和升级两种方式部署环境，开发和测试人员按1:1进行配比。

在测试流程上，开发在自己的 Story Branch 上进行，一旦开发，测试介入，开始针对特定的 Branch 进行测试，同时形成测试脚本，测试通过 Story Branch Merge 到 Developer Branch，每两周做一次大回归测试，把所有测试脚本在 Developer Branch 上面执行一遍，如果没有问题 Merge 到 Master Branch。

在测试调度上，分三种模式。一个是侦听模式，自动化测试框架自动化侦听是否有新的 Build 在 Jenkins 中生成，一旦生成，触发自动化测试执行，这种场景适合在工作时间以外执行。二是即时打包模式，自动化测试框架自动对现有代码进行打包，然后触发自动化测试执行，这种场景用在测试人员想立即触发自动化测试。三是即时运行模式，和第二种模式差不多，区别在于没有打包动作，而是利用已经存在的包触发自动化测试，这种场景适用于需要对指定的 Build 进行测试，因为正常来讲，不可能只有一个 Build，在开发阶段一个 Story Branch 就会形成一个 Build，每个测试人员负责的 Branch 和 Build 是不一样的，所以这个功能很有必要。
##### **自动化测试成果**
自动化测试帮助产品达到了100%的接口测试覆盖率和50%的 UI 测试覆盖率。之所以 UI 测试的覆盖率会比较低，是因为 UI 本身有很多主观检查在里面，也可以说自动化测试本身有自己的局限，这个就涉及到了下一个话题。

### 自动化测试的局限

虽然自动化测试极大地提升了测试效率，但在技术层面上它还是有一定的局限。最经常碰到的情形，当属“验证码识别”。虽然可以利用OCR技术进行图像识别和分析，但是从实验数据来看，准确率不足50%，而且这个数据是在验证码图片不复杂的情况下得出的，如果复杂程度高，准确率更低。如图4所示，从六个方面列举了自动化测试的局限。

<img src="http://ipad-cms.csdn.net/cms/attachment/201601/568a320ae014c.png" alt="图4  自动化测试局限" title="图4  自动化测试局限" />

图4  自动化测试局限

### 自动化测试的投资回报率

接下来从投资回报率（ROI）的角度来分析，如何更好地制定自动化测试战略。从图5中不难看出，自动化测试在执行时间层面并没有比手工测试快，而且脚本复杂的判断逻辑和轮询等待，会导致自动化累计执行时间比手工更长。但是，我们忽略了一个事实，那就是自动化是可以并行执行的，而手工就不行了，于是，可以得出一个公式：SUM（脚本执行时间）=Max（脚本执行时间）。所以，自动化的程度越高，自动化所得到的投资回报率越大，于是，得出第一个结论：自动化测试回报在于并行执行。

<img src="http://ipad-cms.csdn.net/cms/attachment/201601/568a32525eb84.png" alt="图5  自动化测试回报" title="图5  自动化测试回报" />

图5  自动化测试回报

从回报层面讲，并行执行确实为整个测试节省了大量的时间，但从投资层面讲，自动化的投资其实是一项价格高昂的投入。框架和脚本的开发都需要大量时间和相对较高的人力成本。如果以人时为单位，当试图把一个100个人时的手工测试用例转化成自动化实现，那么，极有可能是：400个人时的开发投入+24小时的执行时间。如果系统复杂，高出的倍数就不止是4倍。如果是这样，那为什么还要做自动化？

如图6所示，随着迭代次数的增加，自动化测试的人时曲线和手工测试的人时曲线会在某一点交汇，而在这个点之后，自动化测试的回报就开始产生了，也就是投资回报率就开始呈现出正数，而这个点就是迭代次数。于是，得出第二个理论：自动化测试的回报在于反复执行。

<img src="http://ipad-cms.csdn.net/cms/attachment/201601/568a328a12069.png" alt="图6  自动化测试回报" title="图6  自动化测试回报" />

图6  自动化测试回报

同时，也能得出一个公式： ROI=（SUM(手工执行时间) * 执行次数 ）- (MAX(自动化执行时间) *执行次数 + 自动化开发时间) / SUM(手工执行时间) * 执行次数 ）