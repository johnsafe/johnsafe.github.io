## 支付宝无障碍体验之路

文/王风升

>中国有600万视障人士使用智能手机，对于 App 开发者来说这是不容忽视的现象，本文介绍支付宝如何在为视障人士提供便利的同时，确保支付安全，让视障者享受着时代带来的便利。

目前中国视障群体约有1300多万，此外中国还有1.3亿65岁以上的老年人。据估算，最少有600万视障者使用智能手机，其中83%需要完全借助读屏软件。如何在为视障人士提供便利的同时确保支付安全？本文将分享支付宝的无障碍体验之路。

2016年5月，一封视障人发给支付宝的公开信，将信息无障碍推到了公众面前。另一方面，近年来由于移动支付市场份额提升，安全事件频出，特别是 Android 领域。密码键盘做为资金安全的一道重要防线受到了越来越多的挑战，2016年初，由于安全原因，市面上主流的移动支付软件都停止支持读屏软件语音输入。

为了遏制日渐上扬的安全事件，支付宝技术部门做了一次密码键盘加固，防止木马、键盘记录器等对用户录入的密码进行后台窃取，也取消了 Android 版密码键盘读屏功能，这一动作虽然极大提高了密码键盘的安全性，却给视障人士的生活带来了不少麻烦。

### 事件响应

技术团队确认问题后，展开了针对 Android 版密码键盘读屏功能专项治理，确定了如下解决方案。

通过引入独创方案拦截 AccessibilityEvent，选择性处理了 hover、click 等关键事件，确保 TTS 朗读功能。从而既保证了安全，又在现有辅助功能框架的基础上完美支持 Talk back。

经过此次事件让我们了解到有这么一群特殊的忠实用户群体，也让技术人员更加关注平台所提供的辅助功能。拿 Android 来说，Google 原生系统针对视弱视障人群提供了超大字体设置、放大手势功能；针对色盲、色弱群体提供了色彩翻转功能；而 Talk back 更是视障人群强有力的助手；Android N 新增的 Voice Access 功能允许用户通过语言指令来操作智能手机或者平板，对于通过触控来完成操作的用户又是一个福音。而在这些方案中，Talk back 对上层应用开发有一定要求，各类 App 支持情况并不很好，而这类成熟的方案又是视障人群多使用的功能，因而关注度很高。在本文中我们主要关注 Talk back 及 Voice over 等解决方案。

了解事件细节之后，公司下决心改善整个支付宝 App 的无障碍用户体验，于是有了接下来的一系列行动。

### 深入了解用户需求

- 组织无障碍用户调研，由相关产品同学主导

  - 确定目前视障用户目前最关注的业务，为后续修复计划提供依据；

  - 对于反应强烈的问题由专项负责人直接敦促在当前或下个版本内给予修复。

- 积极参加视障相关产品交流会

技术同学直接参与并将用户的真实感受带回，既增加了使命感又能真切知道用户的专注点。

- 团队内部在线交流会

在线文章及电梯视频等形式直观地让每位开发、产品能重视无障碍这件事，真切体会到它带来的价值。为以后技术专项推进打下了良好的基础，有了这些了解、互动，使得支付宝这个有着超过500开发测试工程师团队，有超过100款独立产品的超级 App 能协同一致完成后面的专项提升。

### 技术先行：各平台无障碍开发规范及常见问题

无障碍的原理就是用户可以通过特殊手势遍历屏幕中所有可获得焦点的 View，在控件获得焦点后通过 TTS 以听觉等手段提示视障用户，用户可以通过手势激活相应的事件来完成 App 正常交互，有以下几点基本规范：

- 确保所有可交互的 View （可点击、长按、拖动等）都可被遍历，即在滑屏等方式切换焦点时可获得焦点。

- 确保所有可遍历的 View 都有正确的 TTS 朗读。

- 确保所有可遍历的 View 都有真实含义，即要么给用户传达文本信息，要么提示用户如何操作，杜绝无意义的无用可遍历点。

### 理出常见问题及解决方案

总结常见不支持的 Case 及相应的解决方案，给开发者提供 FAQ。事实证明，这个以工程师语言给出的行动指南，在后续修复过程中发挥了不少做用。

#### Android 平台

基本原理：所有 clickable、longClickable、focusable 任意为 true 的 View 都能够得到无障碍焦点。当这些 View 得到焦点时，系统会读出这些 View 的 Text、ContentDescription、hint 等文本信息。而无障碍检测，也是基于这些可以获得焦点 View 的文本信息进行检测。

**一些常见问题及解决方案：**

- ImageButton、 ImageView、CheckBox 类的可交互 View 通过显示设置 contentDescription 来解决。

- 对于因埋点等原因占用了 contentDescription 的情形可以实现 AccessibilityDelegate 然后填充 NodeInfo 的 contentDescription 即可。

- 对于一些不需要被遍历的 View 只需要为 View 添加 importantForAccessibility 属性。

- 由于一些安全措施导致的不可用，给出需要兼顾安全和无障碍的实施方案。对于防止自动化工具类，采取对点击等关键事件的拦截策略。对于防止窃取录入文本的情况采取类似密码键盘的策略绕开 Accessibility Manager，选择性地处理必需的 Accessibility Event。

#### iOS 平台

基本原理：UIAccessibility 是在 UIKit 里的一个非正式协议，提供关于 UI 元素的辅助功能信息。在 UIKit 里的所有标准视图和控件都实现了 UIAccessibility 协议，所以使用标准 UIKit 控件是无需做额外的工作。而自定义的控件，就是需要通过设置 UIAccessibility 属性来达到 VoiceOver 的效果。

**常见问题**

- 对于 UIKit 控件，如 UIButton、UILabel、UITextField 等，请设置 title 或者 text。

- 对于 UIButton 是图片的，无法设置 title，那么请设置 button.accessibilityLabel = @“xxx”。

- 对于 UIView 或者 UIImageView 等绑定响应事件，例如绑定 touch，或添加 UIGestureRecognizer 等手势，建议至少实现以下三个属性，其他属性根据自身业务定制：

```
view.isAccessibilityElement = YES;   
view.accessibilityLabel = @ "xxx";  
view.accessibilityTraits= UIAccessibilityTraitButton;
```

- 对于创建自定义控件，特别是基础控件，提供给业务方使用，则更应该实现按照第三点所说，实现 accessiblity 三个基本属性。
 
**H5 相关**

具体参见 WCAG 2.0 及 WAI-ARIA 开发规范：

- 保证所有可点击的元素可正常被描述，利用 alt、title 及 lable 的 for 等属性。

- 合理的利用 role 属性，增加可交互体验。

- 对于一些利用 CSS+JS 实现的仿 Toast，可能存在无法自动朗出的问题，需要容器提供原生支持。

### 无障碍自动化检测

为了和内部的研发平台结合把无障碍体验流程化，并纳入到正常的研发流程中去，相关工程师开发了用于自动化检测各业务线无障碍支持情况的工具，提供以下几方面的能力。

- 日常问题采集：针对 Android 及 iOS 两平台开发了扫描插件，在开发及测试人员日常测试开发过程中扫描相关问题并采集上报。

- 问题排查：通过报表后台，可以查看每条缺陷所在页面，不支持 View 的 ID 当时截屏并将该 View 标红，可以方便地让开发者迅速定位问题。

- 问题扫描：结合自动化遍历工具采集发版前安装包的无障碍缺陷并通过邮件、IM 等通知到相关开发者。

通过自动化工具，可以在项目研发阶段及时上报问题，打开及时修复，在集成发布阶段进行扫描，确保严重问题在正式发版前及时修复。

### 无障碍体验提升冲刺计划

经过一段时间技术积累，主要思路是在某一版发布前开始一次集中治理。

前期由于内部测试团队缺少无障碍经验，所以一开始联系了一个外部专业团队对该版本的灰度包进行全覆盖测试，从按业务优先级及缺陷等级产出了一份待修复的问题列表。由内部测试工程师将问题转到内部缺陷平台（此步对测试团队是一个学习过程），测试工程师参考前期规范文档迅速展开对问题的修复。

同时由相关产品同学协调外部的特殊用户，将一线用户体验反馈回来，严重的问题也在此过程中得到修复。

在此过程中，积累的问题对续的自动化工具效果提升也有很大帮助。

### 后续

通过以上一系列举措，我们逐步建立起一套完整的方案来确保无障碍体验在项目迭代过程中得到持续跟踪和优化。对内有自动化检测平台和持续集成平台做保障，对外建立常态化反馈通道利用灰度机制，重点采集一些视障用户加入内测白名单，发现正式版前自动化检测工具难以检测的严重无障碍问题。另外，增加基础数据埋点，将这类特殊人群的使用情况数据化，如基本 UV，常用业务分布，常用机型等数据。对这类数据的挖掘，对后面的无障碍体验测试覆盖面等方面都有着重要的指导意义。