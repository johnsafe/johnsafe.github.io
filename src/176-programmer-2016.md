## 红点直播架构设计及技术难点

文/王宇航

### 需求

架构设计的前提是深入理解核心需求。由于直播业务具有及时性、互动性等特点，对架构的需求也有一定共性。

#### 礼物

礼物是一种听众向主播转账的行为。听众可以通过在直播过程中送礼物的形式表达对主播的态度，通常礼物会额外附带一些特殊的全局效果，这种全局效果往往可以被直播间内的主播和所有听众看到。对于送礼物的听众，主播会采用点名答谢等方式与其互动。

#### 聊天
直播过程中，听众可以实时聊天，主播也可以通过聊天与听众互动，因此聊天模式多为群聊，不限于文字、图片、音视频片段等消息，内容显示在直播页面上，群聊过程中主播和听众使用的各项功能、聊天呈现的各种效果可能会对不同用户区别对待。聊天需求需要满足但不限于下面两种情况：

- 已关注主播：可发送语音，输入文字输或表情，同样点击主播头像可观看到其主页并且可以点赞与送钻石；

- 未关注主播：系统可以自动向听众推荐主播，点击可查看其个人信息，关注、发送私信。

产品运营应对聊天进行管理，监控聊天人员，实时聊天记录查看，可以对用户禁言、踢人、解禁，可以删除聊天记录。

#### 在麦列表

直播在麦列表应该能控制谁在进行直播、谁能进行直播，管理同一直播间内不同用户进行直播的规则和次序。在麦列表还应实现主播邀请听众上麦、听众申请连麦、自由上麦、自由排麦等功能，因此在直播期间，主播可以与其中某一位或某几个观众进行互动，其他观众也能看到这个互动过程。同时直播间的主播也应有一定的权限，如设定、删除管理员、剔除用户、禁言等。

这种功能可以实现主播和观众的身份在发起者和参与者之间的自由转化，也给观众更多参与和满足感，提升应用的活跃度和用户黏性。

#### 小黑板

主播在直播的同时，可能需要展示其他内容用以辅助直播，比如电子图片、文字等，而在直播页面中用于展示其他内容的区域就是小黑板，小黑板上可以展示文字、图片、白板等内容。如在红点上，1次最多可以上传9张图片，并可以多次上传，且在传到直播界面前有预览功能。上传好的图片，可以选择删除或者全屏，也可以选择关闭小黑板。

### 架构设计要点

#### 状态同步

通过整理需求不难发现，围绕直播相关业务都是实时在线的业务，要求信息传递延迟低，至少要与直播本身的延迟相当。这些业务的信息主要有两个维度：直播间维度和用户维度。所以在设计逻辑上，我们需要一个消息组件，可以实现信息按某个维度通知到用户端。在这个通知能力的基础上，由业务逻辑服务实现各个功能需求，如图1所示。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c637656bebb.png" alt="图1  状态同步的设计逻辑" title="图1  状态同步的设计逻辑" />

图1  状态同步的设计逻辑

用户端一次可改变状态的操作，会造成业务服务状态的变化，业务服务调用推送系统完成对直播间内其他用户端的状态更新通知的推送。其他用户端根据收到的状态更新通知同步更新本地状态，达到全部用户在该业务服务状态的一致。

其中状态更新引入版本号概念进行管理，其逻辑如图2所示。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c637df7bb1c.png" alt="图2  引入版本号概念进行管理的状态更新" title="图2  引入版本号概念进行管理的状态更新" />

图2  引入版本号概念进行管理的状态更新

用户端在本地记录当前业务服务的本地缓存状态。对于发起操作的用户端，通过操作请求对应的返回，直接更新本地对应业务状态；业务服务接收到导致状态更新的操作以后，首先提升业务状态版本号，将最新状态返回给操作方，并同时向其他用户端发起状态更新通知；其他用户端收到状态更新通知后，通过与本地缓存状态比对，使用版本号最大的状态覆盖更新本地状态。

当短时间内有多个用户端同时发起改变状态的操作时，业务服务在一个推送周期内只推送最大的版本号即可。

#### 推送系统

即时性较好的推送系统通常有3种实现方案，分别是基于 TCP、UDP 网络和基于 HTTP Polling 技术。

- 基于 TCP 网络：受限于 TCP 协议自身的特性，在网络抖动较为剧烈的情况下会执行严格的拥塞控制策略，进而导致在这个环境下的连续消息堵塞，造成延迟，但最终消息可送到客户端。

- 基于 UDP 网络：UDP 是一种数据报协议，本身不提供数据传输质量的保障，需要应用程序自行解决对传输质量的把控问题，同时有些网络环境禁用 UDP 协议。

- 基于 HTTP Polling 技术：HTTP Polling 技术已经成熟应用于 Web 端的推送技术，框架成熟。

在直播业务场景中，状态变化的时序往往没有严格、一致的约束，因此可以引入服务状态版本的概念对状态进行覆盖式更新。所以在直播业务场景中，不同推送系统在状态最终同步的过程中扮演的角色不同。为了达到状态最终同步的目的，结合直播业务的特点，我们可以将解决方案大致划分为两种：一种是推送系统确保送达，另外一种是用户端确保状态最终一致。

- 推送系统确保送达的方案：要求推送系统在用户端实现对每次推送有回应，对于没有收到回应的推送，推送系统需要有持久化重试的机制，直到客户端确定收到为止。使用确保送达的系统可以简化业务实现方式，将业务逻辑建立在推送系统更新的业务状态上。

- 用户端确保状态最终一致的方案：实际上是将推送系统作为辅助通知，降低状态同步所需的时间。该方案需要用户端能够主动获取业务最新状态。当推送丢失时，由于用户端本地无法获得状态改变的信息，用户端必须周期性进行同步，以确保状态最终一致。

红点直播采用的是用户端确保状态最终一致的方案，其中的推送系统是使用 Go 语言，基于 UDP 网络实现，该方案中的推送系统仅作为提高状态、更新效率的一种补充，数据的最终一致性是靠周期性同步来完成的。

我们采用这种方案，一方面是为了在实际开发中，降低总体开发成本；另一方面也是复用多媒体分发服务的模块和结构。多媒体分发服务是我们使用 Go 语言自主研发的基于 UDP 网络的分布式流媒体传输系统。

#### 可用性

直播场景的用户都是实时在线体验产品的，相比于其他类型的业务，直播业务对服务的可用提出了更高的要求。直播业务具有以下几个特点：突发性、高并发、时效性、瞬时弱一致。直播活动，如果不是教育类的常规课程，或者预付费内容，其并发量往往难以预估。而且并发来临时，一般会在数分钟内完成数量级的跃迁，形成突发压力。在直播过程中，部分业务数据会有持久化需求，但是大部分业务数据是时效性数据，直播结束后就不再有意义。在产品体验上，直播过程中的数据允许短时间内不一致，只要最终达成一致即可。

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c638dc0e33a.png" alt="可用性" title="可用性" />

图3 实现请求向可用服务调用的负载均衡器

我们可以通过一个负载均衡器实现请求向可用服务的调用，如图3所示。

在服务接入环节我们使用 Nignx 承担负载均衡功能。负载均衡器除了能够处理不可用服务的转移，还需要将均衡策略反馈到服务调度系统，处理弹性扩容缩容。在负载均衡环节，采用按直播间区分的一致性 Hash 策略可以很好地优化资源配置。在红点的流媒体分发系统中，我们使用 Etcd 作为解决服务治理的中间件。这里我们正在尝试使用 Etcd + Docker 的方案解决弹性问题。与 Etcd 能力相近的项目还有 ZooKeeper、Consul 等，在我们的业务场景下这3者都能满足需求。

#### 业务架构

<img src="http://ipad-cms.csdn.net/cms/attachment/201609/57c63922cdc6d.png" alt="图4  业务架构" title="图4  业务架构" />

图4  业务架构

如图4所示，我们为聊天、礼物、小黑板、在麦列表4项服务增加了一个前置状态同步服务。这里的前置状态同步服务有两个作用：一是提供在线列表服务；二是归并状态同步请求，作为后置其他服务的业务缓存。当用户端产生一个改变业务服务状态的操作时，业务服务会清除状态同步服务的缓存，然后再调用推送系统向用户端发起通知。此时状态服务缓存中没有该服务的最新状态，其他用户端收到通知后，根据推送内容，决定是否与缓存同步最新状态。  

### 结语

本文以红点直播业务架构的一些探索为例，整理直播业务需求，从状态同步、推送系统、可用性和业务架构4个角度阐述红点直播业务的构架设计要点，为快速搭建直播体系提供一个可选的业务架构设计方案。